<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="author" content="Guru Devanla">
        <title>Metaclasses at work - Generating well formed tests in Python</title>

        <!--web fonts-->
        <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
        <link href="http://fonts.googleapis.com/css?family=Belgrano" rel="stylesheet" type="text/css">

        <link rel="stylesheet" href="/theme/css/main.css" />
        <link rel="stylesheet" href="/theme/css/pygment.css"/>
        <link rel="stylesheet" href="/theme/css/emacs.css"/>


           <script type="text/javascript">

               var _gaq = _gaq || [];
                 _gaq.push(['_setAccount', 'UA-45968778-1']);
                 _gaq.push(['_trackPageview']);

                 (function() {
                   var ga = document.createElement('script'); ga.type =
                   'text/javascript'; ga.async = true;
                   ga.src = ('https:' == document.location.protocol ?
                   'https://ssl' : 'http://www') +
                   '.google-analytics.com/ga.js';
                   var s = document.getElementsByTagName('script')[0];
                   s.parentNode.insertBefore(ga, s);
                 })();

               </script>

        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
              Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-45968778-2', 'gdevanla.github.io');
              ga('send', 'pageview');

        </script>
</head>

<body>
    <header>
        <span><a class="title" href="/index.html"><h1>blog <| code </h1></a></span>
        <nav>
            <ul>
                    <li><a href="/index.html">posts</a></li>
                    <li><a href="/archives.html">archives</a></li>
                    <li><a href="/pages/who-am-i.html">about</a></li>
                    <li><a href="/pages/books.html">book</a></li>
            </ul>
        </nav>
    </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h2>
        <a class="title" href="/metaclasses-at-work-in-python.html" rel="bookmark"
           title="Permalink to Metaclasses at work - Generating well formed tests in Python">Metaclasses at work - Generating well formed tests in Python</a></h2>
      <div class="extra-info">
                <abbr class="published" title="2016-09-08T00:00:00-07:00">
                    09-08-2016
                </abbr>
                In <a href="/category/python-testing.html">Python, testing</a>.       </div><!-- /.entry-content -->

    </header>
    <p>I was fortunate to be given an opportunity to give a lightening talk at Pycon
2016. I spoke about how we can generate well-formed tests using the
meta-classes facility of Python.</p>
<p>Problem Statement:</p>
<p>In many instances, we end up with tests that check for a common set of
invariants for a large set of inputs.  For example, say we need to
test a function such as</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Args:  x, y z are Bool&#39;s</span>
<span class="sd">    &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">z</span><span class="p">)</span>
</pre></div>


<p>To generate a comprehensive set of tests for this function, we will
need 8 tests, which all look the same except for the input that will vary.</p>
<div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">TestUnit</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">TestFunctionFooMeta</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">check_common_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual_value</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual_value</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_scenario_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_scenario_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_scenario_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
</pre></div>


<p>Our objective here is to avoid such bolierplate code. In the
real-world the 8 scenerios expresssed here could translate into 100's of
inputs from production data that can be used to regression test new
changes to code.</p>
<p>The alternate approach of looping around all the input and have the
assert statements in the loop is not desirable, since we loose the
descriptive error reporting mechanism of provided by the test runtime.
For example, if a test fails, you really would not know which input
the tests failed for. It would be an anti-pattern to take such
an approach. Here is an example of the anti-pattern.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">test_all_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This test is an anti-pattern. Looping around all inputs</span>
<span class="sd">        does not provide a good error reporting mechanism when test fails</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
        <span class="n">expected_results</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">True</span><span class="p">,</span>
                <span class="bp">False</span><span class="p">,</span>
                <span class="bp">True</span><span class="p">,</span>
                <span class="bp">True</span><span class="p">,</span>
                <span class="bp">True</span><span class="p">,</span>
                <span class="bp">False</span><span class="p">,</span>
                <span class="bp">True</span><span class="p">,</span>
                <span class="bp">False</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</pre></div>


<p>In the real world, this would apply to any complex application that deals
with lot numeric data and produces a large data set of outputs. It would
be beneficial to be able to use past production data(which we assume
would have been validated, by its use), and assume that to be a good
indicator ot expected output. Coupling the input that went into
producing that production data, we could create valuable tests that
could be handy as a regression test suite and can also be used
effectively while refactoring our code.</p>
<p>So, how do we avoid such bolier plate code? One option is to use
Python's meta-classes facility to auto-generate our tests.</p>
<p>Lets do this in steps:</p>
<ol>
<li>We will need a factory function that will create our test methods,
that we will attach to our test class.</li>
</ol>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">create_func</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">expected_args</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="o">*</span><span class="n">input_args</span><span class="p">)</span>   <span class="c1"># call the Function under test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_common_invariants</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_args</span><span class="p">)</span>
            <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;test_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
</pre></div>


<p>Here the <code>create_func</code>, returns a <code>func</code> object. This <code>func</code> will be
attached to the Test class we will create in the next few steps. This
<code>func</code> object will be the <code>test_*</code> method in the test
class. We will create as many <code>func</code> objects as the number of test
inputs we have. The <code>func</code> object, will in turn invoke the
<code>foo</code> method and then call all function, that will verify all the
invariants that the result of the function has to satisfy.</p>
<p>Now, let's look at how we can loop around all test inputs and attach
the <code>func</code> object to the test classes. We will create a class, that
will act as a meta class for our test class.</p>
<div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">TestFunctionFooMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">create_func</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">expected_args</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="o">*</span><span class="n">input_args</span><span class="p">)</span>   <span class="c1"># call the Function under test</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_common_invariants</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_args</span><span class="p">)</span>
                <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;test_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">func</span>

            <span class="c1"># get_test_args yields (test_name, input_args, expected_value)</span>
            <span class="k">for</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">expected_args</span> <span class="ow">in</span> <span class="n">get_test_args</span><span class="p">():</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">create_func</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">expected_args</span><span class="p">)</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</pre></div>


<p>We see that we plugged in the <code>create_func</code> into the <strong>new</strong>
function of the class we will use to create our Test class. Between,
line 11 and 13, we loop over all possible inputs, and expected output,
get a new <code>func</code> for each instance and then attach the newly
minted <code>func</code> to the Test class that is getting created.</p>
<p>And, here is the definition of <code>get_test_args</code>.</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">get_test_args</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">repeat</span>
        <span class="n">input_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="n">expected_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">True</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">,</span>
            <span class="bp">True</span><span class="p">,</span>
            <span class="bp">True</span><span class="p">,</span>
            <span class="bp">True</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">,</span>
            <span class="bp">True</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">]</span>

        <span class="n">test_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_args</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">test_names</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">expected_args</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">test_name</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>


<p>All this function does is to generate the input/output mapping. In a
real-world example, this method would essentially be assembling the input
and grabbing the expected results from production data. That way,
effective regression tests can be built using real-data.</p>
<p>Here is the <a href="https://gist.github.com/gdevanla/3a94956541dc142370efb89313ac09fe">gist</a>.</p>


  </article>
</section>
    <footer>
        <hr>
        <div class="social">
            <ul>
                <li><a href="http://github.com/gdevanla">GitHub</a></li>
                <li><a href="http://twitter.com/grdvnl">Twitter</a></li>
            </ul>
            <ul>
                <li>
                    Powered by Pelican
                </li>
            </ul>
        </div><!-- /.social -->


<!--  -->

</body>
</html>