<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="author" content="Guru Devanla">
        <title>Read you a Scotty</title>

        <!--web fonts-->
        <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
        <link href="http://fonts.googleapis.com/css?family=Belgrano" rel="stylesheet" type="text/css">

        <link rel="stylesheet" href="/theme/css/main.css" />
        <!-- <link rel="stylesheet" href="/theme/css/pygment.css"/> -->
        <link rel="stylesheet" href="/theme/css/default.css"/>


           <script type="text/javascript">

               var _gaq = _gaq || [];
                 _gaq.push(['_setAccount', 'UA-45968778-1']);
                 _gaq.push(['_trackPageview']);

                 (function() {
                   var ga = document.createElement('script'); ga.type =
                   'text/javascript'; ga.async = true;
                   ga.src = ('https:' == document.location.protocol ?
                   'https://ssl' : 'http://www') +
                   '.google-analytics.com/ga.js';
                   var s = document.getElementsByTagName('script')[0];
                   s.parentNode.insertBefore(ga, s);
                 })();

               </script>

        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
              Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-45968778-2', 'gdevanla.github.io');
              ga('send', 'pageview');

        </script>
</head>

<body>
    <header>
        <span><a class="title" href="/index.html"><h1>blog <| code </h1></a></span>
        <nav>
            <ul>
                    <li><a href="/index.html">posts</a></li>
                    <li><a href="/archives.html">archives</a></li>
                    <li><a href="/pages/who-am-i.html">about</a></li>
                    <li><a href="/pages/books.html">book</a></li>
            </ul>
        </nav>
    </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h2>
        <a class="title" href="/read-you-a-scotty.html" rel="bookmark"
           title="Permalink to Read you a Scotty">Read you a Scotty</a></h2>
      <div class="extra-info">
                <abbr class="published" title="2017-05-22T00:00:00-07:00">
                    05-22-2017
                </abbr>
                In <a href="/category/misc.html">misc</a>.       </div><!-- /.entry-content -->

    </header>
    
<div id="header">
<h1>Read you a Scotty</h1>
<span id="author">Guru Devanla</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2017-02</span>
</div>
<div id="content">
<div class="sect1">
<h2 id="_prologue">Prologue</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_about_the_book">About the book</h3>
<div class="paragraph"><p>Part of a <em>Read You A _</em>&#8482; series.
&#169; 2017 Guru Devanla</p></div>
<div class="paragraph"><p><span class="monospaced">Scotty</span> is a relatively light-weight and interesting Haskell library
that can be used to inform novice Haskeller&#8217;s on how Haskell is used in the
real world. It provides the next level of reading to learn Haskell by
exploring the use of the powerful data structures Haskell provides.
The purpose of this book is to educate the reader beyond just learning
the basics of programming in Haskell. Many other books currently
available cover Haskell as a language at various depths. This book
follows the same spirit as the popular <em>Real World Haskell(RWH)</em> book. The
<span class="monospaced">RWH</span> teaches the language and its use in real world scenarios. This
mini-book takes a deeper dive into one specific library and exposes the
reader to ways in which the various data structures in Haskell are put
to use.</p></div>
<div class="paragraph"><p>The main objective of this book are as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Expose the reader
    to practical examples of use of Monads, Monad Transformers other power structures Haskell provides. Scotty
    library uses all the important monads(State, Maybe, Reader) taught
    in beginner Haskell books
</p>
</li>
<li>
<p>
Looks at how these computation
    structures are organized in a purely functional manner
</p>
</li>
<li>
<p>
Educate the reader, so that they can contribute to Scotty or
    build similar powerful libraries
</p>
</li>
</ol></div>
<div class="paragraph"><p>At the minimum, after reading this book, the reader should be able to
reason with any code that is implemented using Scotty as the web
framework.</p></div>
<div class="paragraph"><p>This book assumes basic familiarity of the reader with Haskell
concepts. Some of the advanced data structures that will be used in
the later parts of the book are introduced in the first chapter in a
gradual manner. But, this introduction does not provide detailed
explanations to concepts that are available in other general books on
Haskell.</p></div>
</div>
<div class="sect2">
<h3 id="_how_to_read_this_book">How to read this book</h3>
<div class="paragraph"><p>This book obviously uses extensive references to the Scotty source
code. Appropriate links are provided to the source code from the
sections where the code is discussed. It could be beneficial to clone
the <a href="https://github.com/scotty-web/scotty.git">scotty</a> library from its
original source locally and explore the code as the book is read.</p></div>
<div class="paragraph"><p>If you desire a <span class="monospaced">stack</span> enabled version, and the version the book
links the source code to, you can fork a version from
<a href="https://github.com/gdevanla/scotty.git">scotty-forked</a>. This version is
forked so as to be able to refer to a consistent version of the
library from different sections in this book and also can be built using
<span class="monospaced">stack</span>.</p></div>
<div class="paragraph"><p>Also, refer to the References section to refer to resources I used in
helping me understand the implementation. These resources can provide
the missing pieces not covered in this book.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter gives an overview of the approach taken in this book to
help the reader read through the  <span class="monospaced">Scotty</span> implementation. As stated, in
the Prologue this book is intended to help familiarize ourselves with
Haskell&#8217;s use in real-world. Therefore, the book will assume basic
knowledge in Haskell (acquired from books like LYH, Haskell from First
Principles etc).</p></div>
<div class="paragraph"><p>One could go about reading an existing implementation in two
ways. One approach is to delve in right away and start looking through
the code until  we reach a logical starting point from where we can
anchor our understanding. From the logical point we could traverse the
code in different directions to enhance our understanding of the
code. Typically, we could take this approach if we find ourselves in a
situation where we want to learn the code by fixing a particular bug
or working on a new feature request.</p></div>
<div class="paragraph"><p>Alternatively, we could sit back (if we have the time), and think
about the different ways of solving the problem at hand. Then, with
that idea, if we were to look at the existing implementation, the
process we went through could inform us on why the code
has been implemented the way it is.</p></div>
<div class="paragraph"><p>For our purposes, to understand the <span class="monospaced">Scotty</span> implementation we will
take the latter approach. As a first step, we will create our own toy
implementation of the <span class="monospaced">Scotty</span> like framework. While we do this we
will reason about the limitations of our code during each iteration
and then improve on that. After a few iterations we will be at a
point, where our code will closely represent the overall design of the
original <span class="monospaced">Scotty</span> implementation. This exercise will both, make it
easy to read through the original implementation and also provide a
way of reasoning about the design decisions reflected in the
code.</p></div>
<div class="paragraph"><p>Once we have our toy implementation in place, we start off by looking
at a simple web application built using <span class="monospaced">Scotty</span>. That will help us
define some terminology that we can use across the book. Some of this
terminology is also introduced while we implement our toy framework.</p></div>
<div class="paragraph"><p>We then turn our attention to a simple type <span class="monospaced">Options</span> that will
introduce us to the
(<a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L1)"><span class="monospaced">Types.hs</span></a>.
The <span class="monospaced">Types.hs</span> module contains all the type definitions used by the
<span class="monospaced">Scotty</span> library.</p></div>
<div class="paragraph"><p>One of the first things we need to do while defining a web application
is to map the different HTTP requests to methods that act on those
requests. We need a way to thread the requests through different
actions that serve request. We call this process <span class="monospaced">routing</span>. Therefore,
next we look at how this <span class="monospaced">routing</span> pipeline is created by <span class="monospaced">Scotty</span>.</p></div>
<div class="paragraph"><p>Once the <span class="monospaced">routing</span> pipeline is created, then we can look at how the
user requests are threaded through these actions. This will give us
insight on how the <span class="monospaced">scotty state</span> is unwrapped before each request and
how the <span class="monospaced">requests</span> are passed on to the appropriate <span class="monospaced">action</span>.</p></div>
<div class="paragraph"><p>Next, we look closely at a <span class="monospaced">routing</span> function in detail. The <span class="monospaced">routing</span>
function threads each request through an action by matching an <span class="monospaced">url</span>
pattern. We will also come across the <span class="monospaced">ActionT</span> monad that wraps an
environment (HTTP request information), the <span class="monospaced">response</span> and any error
values that may have been created.</p></div>
<div class="paragraph"><p>By now we would have looked at most of the core <span class="monospaced">Scotty</span>
implementation. We will continue to explore the other parts of library
, namely <span class="monospaced">parameter handling</span> and <span class="monospaced">Response</span> creation and handling.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_a_toy_scotty">A Toy Scotty</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this section we will build a simple framework. This framework will
allow us to  creates route handlers that will represent the various
routes in a web app, provide default routes and also handle
errors. We will start with the simplest of setups and slowly work our
way towards a model that closely represents the design that is used
in Scotty. The hope is this step by step approach to a relatively
Scotty like model will help the reader understand the Scotty code
better when we start exploring the code in the later chapters.</p></div>
<div class="paragraph"><p>Each iteration in this chapter is contained in one independent
module. Each module contains both the <span class="monospaced">server</span> code that will serve
requests and <span class="monospaced">client</span> code that will simulate any handlers the
client(user of our framework) provides. The client usually provides the
<span class="monospaced">route</span> handlers that contain the custom logic to handle requests. The
server code does the job of calling this handlers to process request
before sending back the response.</p></div>
<div class="paragraph"><p>All the code examples discussed in this section is available at
<a href="https://github.com/gdevanla/scotty-from-ground-up/">scotty-from-ground-up</a>.</p></div>
<div class="paragraph"><p>The code can be compiled using <span class="monospaced">stack</span>. To run the example, in the
first iteration of this chapter follows these steps.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
stack build

stack exec main1</tt></pre></div></div>
<div class="paragraph"><p>Each module can be run as <span class="monospaced">stack exec mainX</span> , where <span class="monospaced">X</span> is the number
of the iteration. For example, the command to run the code in the
first iteration would be <span class="monospaced">stack exec main1</span>.</p></div>
<div class="sect2">
<h3 id="_first_iteration">First Iteration</h3>
<div class="paragraph"><p>The code discussed in this iteration is available at
<a href="https://github.com/gdevanla/scotty-from-ground-up/blob/master/app/Main1.hs">Main1.hs</a>.</p></div>
<div class="paragraph"><p>Our first task is to declare some of the data types we will need.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">import</span></span> qualified Control<span style="color: #990000">.</span>Monad<span style="color: #990000">.</span>Trans<span style="color: #990000">.</span>State<span style="color: #990000">.</span><span style="color: #009900">Strict</span> as <span style="color: #009900">ST</span>
<span style="font-weight: bold"><span style="color: #0000FF">import</span></span> Data<span style="color: #990000">.</span><span style="color: #009900">List</span>
<span style="font-weight: bold"><span style="color: #0000FF">import</span></span> Control<span style="color: #990000">.</span><span style="color: #009900">Monad</span>

<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Route</span> <span style="color: #990000">=</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span>

<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">AppState</span> <span style="color: #990000">=</span> <span style="color: #009900">AppState</span> <span style="color: #990000">{</span> routes<span style="color: #990000">::[</span><span style="color: #009900">Route</span><span style="color: #990000">]}</span>

<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">AppStateT</span> <span style="color: #990000">=</span> ST<span style="color: #990000">.</span><span style="color: #009900">State</span> <span style="color: #009900">AppState</span>
</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">Route</span> type will be a set of routing functions the client can add
to handle different requests. We will have to capture the list of
<span class="monospaced">routes</span> provided by the client. We do that by wrapping the <span class="monospaced">Route</span>
type in  <span class="monospaced">AppState</span>. Since, we will be creating the list of <span class="monospaced">Routes</span>
during runtime we wrap our <span class="monospaced">AppState</span> in a <span class="monospaced">State</span> monad. We will
update this state monad as a first step when the application is run.</p></div>
<div class="paragraph"><p>As part of the framework methods, we want the user to be able to
declare all the routes that need to be checked to handle any
request. We let the user invoke <span class="monospaced">myScotty</span> with the function that
declares all the routes of the app. Our first iteration of the
framework functions will look as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">--  framework methods</span></span>

addRoute' <span style="color: #990000">::</span> <span style="color: #009900">Route</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">AppState</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">AppState</span>
addRoute' mf s<span style="color: #990000">@</span><span style="color: #009900">AppState</span> <span style="color: #990000">{</span>routes <span style="color: #990000">=</span> mw<span style="color: #990000">}</span> <span style="color: #990000">=</span> s <span style="color: #990000">{</span>routes <span style="color: #990000">=</span> mf<span style="color: #990000">:</span>mw<span style="color: #990000">}</span>

addRoute mf <span style="color: #990000">=</span> ST<span style="color: #990000">.</span>modify <span style="color: #990000">$</span> <span style="color: #990000">\</span>s <span style="color: #990000">-&gt;</span> addRoute' mf s

runMyApp <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> ST<span style="color: #990000">.</span><span style="color: #009900">State</span> <span style="color: #009900">AppState</span> a <span style="color: #990000">-&gt;</span> m <span style="color: #009900">String</span>
runMyApp initial_string my_app <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> s <span style="color: #990000">=</span> ST<span style="color: #990000">.</span>execState my_app <span style="color: #009900">AppState</span><span style="color: #990000">{</span> routes <span style="color: #990000">=</span> <span style="color: #990000">[]}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> output <span style="color: #990000">=</span> foldl <span style="color: #990000">(</span>flip <span style="color: #990000">($))</span> initial_string <span style="color: #990000">(</span>routes s<span style="color: #990000">)</span>
  return <span style="color: #990000">$</span> output

myScotty my_app <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  putStrLn <span style="color: #FF0000">"Please type in the request"</span>
  putStrLn <span style="color: #FF0000">"(one of 'handler1', 'handler2', 'handler3', 'buggy' or any string for default handling)"</span>
  request <span style="color: #990000">&lt;-</span> getLine
  unless <span style="color: #990000">(</span>request <span style="color: #990000">==</span> <span style="color: #FF0000">"q"</span><span style="color: #990000">)</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> response <span style="color: #990000">=</span> runMyApp request myApp
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> response <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
      <span style="color: #009900">Just</span> x <span style="color: #990000">-&gt;</span> putStrLn x
      <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> putStrLn <span style="color: #FF0000">"Error"</span>
    main
</tt></pre></div></div>
<div class="paragraph"><p>Here, the client will invoke &#8216;myScotty` with a function that returns
`AppStateT ()&#8217;. An example implementation of route handlers that uses
the simple framework will be</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- client functions</span></span>
constructResponse <span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">String</span><span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span>
constructResponse <span style="color: #990000">=</span> unwords

routeHandler1 <span style="color: #990000">::</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span>
routeHandler1 request <span style="color: #990000">=</span>
  constructResponse <span style="color: #990000">[</span>
  <span style="color: #FF0000">"\nrequest in handler1: got "</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

routeHandler2 <span style="color: #990000">::</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span>
routeHandler2 request <span style="color: #990000">=</span> constructResponse <span style="color: #990000">[</span>
      <span style="color: #FF0000">"\n\trequest in handler2 got :"</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

routeHandler3 <span style="color: #990000">::</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span>
routeHandler3 request <span style="color: #990000">=</span> constructResponse <span style="color: #990000">[</span>
  <span style="color: #FF0000">"\n\t\trequest in handler3:"</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

myApp <span style="color: #990000">::</span> <span style="color: #009900">AppStateT</span> <span style="color: #990000">()</span>
myApp <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  addRoute routeHandler1
  addRoute routeHandler2
  addRoute routeHandler3
</tt></pre></div></div>
<div class="paragraph"><p>Here as a client of the framework we will create three functions
<span class="monospaced">routeHandlerX</span> functions that will be the handlers for processing a
respective requests. We will add these route handlers using the
<span class="monospaced">addRoute</span> method in <span class="monospaced">myApp</span>.  The <span class="monospaced">myApp</span> will be the argument to
<span class="monospaced">myScotty</span> function provided by the framework.</p></div>
<div class="paragraph"><p>Finally, our <span class="monospaced">main</span> will be</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>main <span style="color: #990000">::</span> <span style="color: #009900">IO</span> <span style="color: #990000">()</span>
main <span style="color: #990000">=</span> myScotty myApp</tt></pre></div></div>
<div class="paragraph"><p>Here we call <span class="monospaced">myScotty</span> and provide the list of handlers that can be
used to process requests.</p></div>
<div class="paragraph"><p>Now let us look closely at what is happening in our toy framework
methods. You can ignore what is happening in <span class="monospaced">main</span> for now. In the
<span class="monospaced">main</span> function we just loop around and wait for user input to be
processed.  The functions of interest to us would be <span class="monospaced">addRoute</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>addRoute' <span style="color: #990000">::</span> <span style="color: #009900">Route</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">AppState</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">AppState</span>
addRoute' mf s<span style="color: #990000">@</span><span style="color: #009900">AppState</span> <span style="color: #990000">{</span>routes <span style="color: #990000">=</span> mw<span style="color: #990000">}</span> <span style="color: #990000">=</span> s <span style="color: #990000">{</span>routes <span style="color: #990000">=</span> mf<span style="color: #990000">:</span>mw<span style="color: #990000">}</span>

addRoute mf <span style="color: #990000">=</span> ST<span style="color: #990000">.</span>modify <span style="color: #990000">$</span> <span style="color: #990000">\</span>s <span style="color: #990000">-&gt;</span> addRoute' mf s

runMyApp <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">AppState</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">String</span>
runMyApp initial_string my_app <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> output <span style="color: #990000">=</span> foldl <span style="color: #990000">(</span>flip <span style="color: #990000">($))</span> initial_string <span style="color: #990000">(</span>routes my_app<span style="color: #990000">)</span>
  return <span style="color: #990000">$</span> output

myScotty my_app <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> app_state <span style="color: #990000">=</span> ST<span style="color: #990000">.</span>execState my_app <span style="color: #009900">AppState</span><span style="color: #990000">{</span>routes<span style="color: #990000">=[]}</span>
  userInputLoop app_state</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">main</span> function, applies <span class="monospaced">myScotty</span> to myApp. The <span class="monospaced">myScotty</span>
function first sets up the state of AppState. The <span class="monospaced">app_state</span> values
has the list of router handlers that were declared in <span class="monospaced">myApp</span>. When
<span class="monospaced">myApp</span> is evaluated, each expression in <span class="monospaced">myApp</span> calls <span class="monospaced">addRoute</span>
which modifies the state of <span class="monospaced">AppState</span>. Therefore, in <span class="monospaced">myScotty</span> when
we <span class="monospaced">execState</span>, the AppState objects has all the <span class="monospaced">routes</span> stored in
the <span class="monospaced">routes</span> attribute.</p></div>
<div class="paragraph"><p>After we <span class="monospaced">execState</span> and set up the state of <span class="monospaced">AppState</span>, we are ready
to run a loop (that simulates a server) and start handling user
requests. In <span class="monospaced">userInputLoop</span>, after accepting the input string from
the <span class="monospaced">user</span>, we apply <span class="monospaced">runMyApp</span> to the user input and pass along our
<span class="monospaced">AppState</span> value that has all the routes stored in it. The <span class="monospaced">runMyApp</span>
function folds over the list of <span class="monospaced">routes</span> and applies each <span class="monospaced">route</span>
to the previous <span class="monospaced">request</span> string passed to it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>userInputLoop app_state <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  putStrLn <span style="color: #FF0000">"Please type in the request"</span>
  putStrLn <span style="color: #FF0000">"(one of 'handler1', 'handler2', 'handler3', 'buggy' or any string for default handling)"</span>
  request <span style="color: #990000">&lt;-</span> getLine

  unless <span style="color: #990000">(</span>request <span style="color: #990000">==</span> <span style="color: #FF0000">"q"</span><span style="color: #990000">)</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> response <span style="color: #990000">=</span> runMyApp request app_state
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> response <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
      <span style="color: #009900">Just</span> x <span style="color: #990000">-&gt;</span> putStrLn x
      <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> putStrLn <span style="color: #FF0000">"Error"</span>
    main</tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s run the module and provide some input at the prompt.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>stack build

stack exec main1</tt></pre></div></div>
<div class="paragraph"><p>You will notice, that this is not how we want apply <span class="monospaced">routes</span> to a user
request. We only want the user <span class="monospaced">request</span> processed by one route. But,
hang on. We do this to help us build towards what we ultimately need.</p></div>
</div>
<div class="sect2">
<h3 id="_second_iteration">Second Iteration</h3>
<div class="paragraph"><p>We notice that in the first iteration our code did not do a good job
of processing requests only with one handler.  We will fix that in this iteration.
To fix that, we need each <span class="monospaced">routeHandler</span> to specify a condition on which it
should be called to  process the request. The code for the second
iteration is available at
<a href="https://github.com/gdevanla/scotty-from-ground-up/blob/master/app/Main2.hs">Main2.hs</a>.</p></div>
<div class="paragraph"><p>First we introduce a few more type synonyms to help us in the
process. We do this so that we can structure computation in
such a way that if one route fails to process the request (since
the request does not meet the condition) we want to be able to chain
our call to the next router. This will become clear when we review the
<span class="monospaced">route</span> function. Also, keep in mind that some of the design decisions
we make here are tuned to get us to a toy framework that closely
resembles the structure in the actual implementation of Scotty.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Application</span> <span style="color: #990000">=</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Route</span> <span style="color: #990000">=</span> <span style="color: #009900">Application</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Application</span></tt></pre></div></div>
<div class="paragraph"><p>We will talk more on this type when we discuss the <span class="monospaced">route</span> function.
We make a change to the <span class="monospaced">addRoute</span> function where instead of calling
<span class="monospaced">addRoute'</span> directly, we call a function called <span class="monospaced">route</span>. This is where
the interesting stuff happens in this iteration.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at the <span class="monospaced">route</span> method.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>route <span style="color: #990000">::</span> <span style="color: #009900">Application</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Bool</span><span style="color: #990000">)</span>
  <span style="color: #990000">-&gt;</span> <span style="color: #009900">Route</span>
route mw pat mw1 input_string <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> tryNext <span style="color: #990000">=</span> mw1 input_string <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> pat input_string
  <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    mw input_string
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    tryNext</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">route</span> method takes an handler function which is of type
<span class="monospaced">Application</span> or <span class="monospaced">String-&gt;String</span>. This type is the <span class="monospaced">routeHandler</span> the
client provides. The <span class="monospaced">route</span> method captures the <span class="monospaced">routeHandlers</span> in
its closure. We call these routeHandlers the <span class="monospaced">action</span>. The second
parameter to this function is the predicate that needs to be <span class="monospaced">True</span>
for this action to be called. When the call to <span class="monospaced">route</span> from <span class="monospaced">addRoute</span>
returns, we have a function of type <span class="monospaced">Route</span>. But, what is this <span class="monospaced">Route</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">Route</span></tt></pre></div></div>
<div class="paragraph"><p>reduces to</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="color: #009900">Application</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Application</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>reduces to</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span></tt></pre></div></div>
<div class="paragraph"><p>Therefore,  what gets added to the <span class="monospaced">routes</span> attribute is a function
(that has the <span class="monospaced">action</span> or <span class="monospaced">routeHandler</span> in its closure), and takes
another <span class="monospaced">Application</span> as a parameter along with the <span class="monospaced">String</span> which
will be our <span class="monospaced">Request</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">route</span> function, calls the enclosed <span class="monospaced">routeHandler</span> if the
predicate is satisfied, else the call is chained to the next
<span class="monospaced">Application</span>.  We can see this action unfold in the foldl operation
used in <span class="monospaced">runMyApp</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>runMyApp def app_state request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> output <span style="color: #990000">=</span> foldl <span style="color: #990000">(</span>flip <span style="color: #990000">($))</span> def <span style="color: #990000">(</span>routes app_state<span style="color: #990000">)</span> request
  return output</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">def</span> here is the <span class="monospaced">defaultRoute</span> handler. You notice that as this
function folds the each value is <span class="monospaced">routes</span> is called with the next
value in <span class="monospaced">routes</span> and the <span class="monospaced">request</span> string. Please take a moment to
understand this. The core part of Scotty happens around this function,
where the processing of <span class="monospaced">actions</span> are setup.  You should try to list
the values of <span class="monospaced">routes</span> as they get created and then fold over those
values and see how the type checks out. As a new user to Haskell this
is an interesting pattern I came across. The <span class="monospaced">types</span> checkout as the
recursive nature of calls unfold. The <span class="monospaced">tryNext</span> function is called
recursively until a particular predicate is met or else in the end the
default route handler is called.</p></div>
<div class="paragraph"><p>The client functions remain the same, except we change the response
and also align the types to the new <span class="monospaced">Application</span> type.</p></div>
<div class="paragraph"><p>Try running this example with suggested input and then with some random input.</p></div>
</div>
<div class="sect2">
<h3 id="_third_iteration">Third iteration</h3>
<div class="paragraph"><p>In the third iteration, we switch the return type of route
handlers. We will update the route handlers to return a <span class="monospaced">Maybe</span>
value. That way, if the value returned is <span class="monospaced">Nothing</span> a default error
handler can be invoked later on.</p></div>
<div class="paragraph"><p>For this we do a couple of changes to the code from the second
iteration. The full code for this iteration is available at
<a href="https://github.com/gdevanla/scotty-from-ground-up/blob/master/app/Main3.hs">Main3.hs</a>.</p></div>
<div class="paragraph"><p>We first update the type variable <span class="monospaced">Application</span> to return a <span class="monospaced">Maybe</span>
value rather than a <span class="monospaced">String</span>. For clarity we also introduce two other
type synonyms, namely, <span class="monospaced">Request</span> and <span class="monospaced">Response</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Response</span> <span style="color: #990000">=</span> <span style="color: #009900">Maybe</span> <span style="color: #009900">String</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Request</span> <span style="color: #990000">=</span> <span style="color: #009900">String</span>

<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Application</span> <span style="color: #990000">=</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span></tt></pre></div></div>
<div class="paragraph"><p>Then we add a default error handler that will be invoked if any of the
<span class="monospaced">routeHandler</span> return a <span class="monospaced">Nothing</span> value.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>errorHandler <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span>
errorHandler request <span style="color: #990000">=</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  request<span style="color: #990000">,</span> <span style="color: #FF0000">"Nothing returned from one of the handlers"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>We then update the <span class="monospaced">route</span> method from second iteration to handle the
<span class="monospaced">Maybe</span> return values. Notice that if a <span class="monospaced">routeHandler</span> was invoked and
if the returned <span class="monospaced">Response</span> from the <span class="monospaced">routeHandler</span> was a <span class="monospaced">Nothing</span>
value, then the <span class="monospaced">errorHandler</span> is invoked.</p></div>
<div class="paragraph"><p>We also update the types of all the framework function to reflect the
change of the response type from <span class="monospaced">String</span> to <span class="monospaced">Maybe String</span>.</p></div>
<div class="paragraph"><p>Now, on the client side, we update all of <span class="monospaced">routeHandlers</span> to return a
<span class="monospaced">Maybe</span> value as a <span class="monospaced">Response</span>.  To show how our change works, the
<span class="monospaced">routeHandler2</span> has been updated to return <span class="monospaced">Nothing</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>routeHandler1 <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span>
routeHandler1 request <span style="color: #990000">=</span>
  <span style="color: #009900">Just</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  <span style="color: #FF0000">"request in handler1: got "</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

routeHandler2 <span style="color: #990000">::</span> t <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span> a
routeHandler2 request <span style="color: #990000">=</span> <span style="color: #009900">Nothing</span>

routeHandler3 <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span>
routeHandler3 request <span style="color: #990000">=</span>
  <span style="color: #009900">Just</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  <span style="color: #FF0000">"request in handler3:"</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

defaultRoute <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span>
defaultRoute request <span style="color: #990000">=</span>
  <span style="color: #009900">Just</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  request <span style="color: #990000">,</span> <span style="color: #FF0000">"processed by defaultRoute"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Try running the program,</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>stack build
stack exec main3</tt></pre></div></div>
<div class="paragraph"><p>When the request string passed to the program is <em>handler2</em>, then the
<span class="monospaced">routeHandler2</span> is called with the request string. Since,
routeHandler2 returns a <span class="monospaced">Nothing</span> value, the <span class="monospaced">errorHandler</span> is
called and no other <span class="monospaced">routeHandlers</span> is invoked from this point for
this <span class="monospaced">Request</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">$</span> stack exec main3
<span style="color: #009900">Please</span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> the request
<span style="color: #990000">(</span>one <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> 'handler1'<span style="color: #990000">,</span> 'handler2'<span style="color: #990000">,</span> 'handler3'<span style="color: #990000">,</span> 'buggy' or any string for
<span style="font-weight: bold"><span style="color: #0000FF">default</span></span> handling<span style="color: #990000">)</span>
handler2
<span style="color: #009900">Request</span><span style="color: #990000">=</span>handler2<span style="color: #990000">,</span> <span style="color: #009900">Response</span><span style="color: #990000">=</span><span style="color: #009900">Nothing</span> returned from one <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> the handlers</tt></pre></div></div>
<div class="paragraph"><p>You will notice that even though we were able to handle <span class="monospaced">Nothing</span>
values returned from some routeHandlers, we still do not handle any
exceptions that could be thrown from the <span class="monospaced">routeHandlers</span>. We
will be taking care of that in later iterations of this code. Also, as
is the case with returning <span class="monospaced">Nothing</span> values, the nature of error is
not available. We could benefit from more information in cases where
<span class="monospaced">routeHandlers</span> cannot process a <span class="monospaced">Request</span> successfully.</p></div>
</div>
<div class="sect2">
<h3 id="_fourth_iteration">Fourth Iteration</h3>
<div class="paragraph"><p>In this iteration of code we would like to handle any exceptions
thrown from any of the <span class="monospaced">routeHandlers</span>. The full code for this
iteration is available at
<a href="https://github.com/gdevanla/scotty-from-ground-up/blob/master/app/Main4.hs">Main4.hs</a>.</p></div>
<div class="paragraph"><p>To get the error handling we need, we go back to our types and refine
them further. The new type definitions we will need in this iteration
are as follows</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Response</span> <span style="color: #990000">=</span> <span style="color: #009900">String</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Request</span> <span style="color: #990000">=</span> <span style="color: #009900">String</span>

<span style="font-style: italic"><span style="color: #9A1900">-- new in this iteration</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">ActionError</span> <span style="color: #990000">=</span> <span style="color: #009900">String</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">ActionT</span> <span style="color: #990000">=</span> Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #009900">ActionError</span> <span style="color: #009900">Maybe</span> <span style="color: #009900">Response</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Application</span> <span style="color: #990000">=</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>

<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Route</span> <span style="color: #990000">=</span> <span style="color: #009900">Application</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Application</span>

<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">AppState</span> <span style="color: #990000">=</span> <span style="color: #009900">AppState</span> <span style="color: #990000">{</span> routes<span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">Route</span><span style="color: #990000">]}</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">AppStateT</span> <span style="color: #990000">=</span> ST<span style="color: #990000">.</span><span style="color: #009900">State</span> <span style="color: #009900">AppState</span></tt></pre></div></div>
<div class="paragraph"><p>Almost all types definitions you see above are carried over from the
previous iteration. The important changes are to the <span class="monospaced">Application</span>
type and by dependency to the <span class="monospaced">Route</span> type.</p></div>
<div class="paragraph"><p>We define an <span class="monospaced">ActionError</span> type, that will hold an <span class="monospaced">exception</span>
string that the <span class="monospaced">routeHandlers</span> can create. Therefore, we need to
be able to wrap the <span class="monospaced">ActionError</span> along with the <span class="monospaced">Maybe Response</span>
value we expect from the <span class="monospaced">routeHandler</span> functions.</p></div>
<div class="paragraph"><p>We reach out to the ExceptT monad for that. The ExceptT monad wraps
the <span class="monospaced">Either e a</span> in an outer monad. We pick this monad transformer,
since in the later sections we will see that we have a need to stack
more monads to get to what we want. Therefore, for this iteration each
<span class="monospaced">routeHandler</span> will either throw an exception which is captured in
<span class="monospaced">ActionError</span> or return a <span class="monospaced">Maybe</span> value which is captured in <span class="monospaced">Maybe
Response</span>. Note that we could have gotten away with an <span class="monospaced">Either e a</span>
monad for this iteration. The type could have been <span class="monospaced">Either ActionError
Request</span>. But, we skip that step and directly reach out to <span class="monospaced">ExcepT</span>
for reasons that become clearer later.</p></div>
<div class="paragraph"><p>Now, we will see how we can handle these exceptions.  Similar to our
previous iterations, we will update all our <span class="monospaced">routeHandlers</span> to reflect
the new types. The <span class="monospaced">routeHandlerBuggy</span> will throw an exception whereas
all other <span class="monospaced">routeHandlers</span> successfully process requests. The new
listing of <span class="monospaced">routeHandlers</span> is shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>constructResponse <span style="color: #990000">=</span> unwords

routeHandler1 <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
routeHandler1 request <span style="color: #990000">=</span>
  Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> <span style="color: #009900">Right</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  <span style="color: #FF0000">"request in handler1: got "</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

routeHandler2 <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
routeHandler2 input <span style="color: #990000">=</span> Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> <span style="color: #009900">Right</span> <span style="color: #990000">$</span> input <span style="color: #990000">++</span> <span style="color: #FF0000">" middleware2 called\n"</span>

routeHandlerBuggy <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
routeHandlerBuggy input <span style="color: #990000">=</span> throwError <span style="color: #FF0000">"Error from routeHandlerBuggy"</span>

routeHandler3 <span style="color: #990000">::</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
routeHandler3 request <span style="color: #990000">=</span>
  Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> <span style="color: #009900">Right</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  <span style="color: #FF0000">"request in handler3:"</span> <span style="color: #990000">++</span> request<span style="color: #990000">]</span>

defaultRoute <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
defaultRoute request <span style="color: #990000">=</span>
  Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> <span style="color: #009900">Right</span> <span style="color: #990000">$</span> constructResponse <span style="color: #990000">[</span>
  request <span style="color: #990000">,</span> <span style="color: #FF0000">"processed by defaultRoute"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>In each of the <span class="monospaced">routeHandlers</span> we construct the response and then wrap
them into <span class="monospaced">Either</span> and then into a <span class="monospaced">Maybe</span> type. The wrapping of
<span class="monospaced">Maybe</span> at this point may not add much value, since a <span class="monospaced">Right</span> value
would indicate error anyways. But, as stated before the use of the
transformer becomes essential for the later steps.</p></div>
<div class="paragraph"><p>Now with the knowledge of how we expect our client to provide the
<span class="monospaced">routerHandlers</span>,we turn our attention to the framework
functions. First, we provide a <span class="monospaced">errorHandler</span> function which will
be invoked from the <span class="monospaced">catch</span> block. This function will be called in
the event of any <span class="monospaced">exception</span> that is thrown from the <span class="monospaced">routeHandlers</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>errorHandler <span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
errorHandler s <span style="color: #990000">=</span> Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> <span style="color: #009900">Right</span> <span style="color: #990000">$</span> <span style="color: #FF0000">"There was an error returned: "</span> <span style="color: #990000">++</span> s</tt></pre></div></div>
<div class="paragraph"><p>Then, we update our <span class="monospaced">route</span> function to <span class="monospaced">catch</span> exceptions. Note, that
we updated the call to <span class="monospaced">errorHandler</span> in third iteration. Instead of
checking for <span class="monospaced">Nothing</span> values before calling the <span class="monospaced">errorHandler</span> (in
third iteration), we call <span class="monospaced">cathcError</span> and provide the <span class="monospaced">errorHandler</span>
as the second argument to the <span class="monospaced">catchError</span>.  We abstract away this
into another function called <span class="monospaced">runAction</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>route <span style="color: #990000">::(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Bool</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Route</span>
route mw pat mw1 request <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> tryNext <span style="color: #990000">=</span> mw1 request <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> pat request <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    runAction mw request
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    tryNext

runAction <span style="color: #990000">::(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span>
runAction mw request <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> response <span style="color: #990000">=</span> Exc<span style="color: #990000">.</span>runExcept <span style="color: #990000">$</span> mw request <span style="color: #990000">`</span>catchError<span style="color: #990000">`</span> errorHandler
      left <span style="color: #990000">=</span>  <span style="color: #990000">(\</span>x <span style="color: #990000">-&gt;</span> <span style="color: #990000">(++)</span> <span style="color: #FF0000">"There was an error :"</span> x<span style="color: #990000">)</span>
      right <span style="color: #990000">=</span> id
  <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    either left right response</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">userInputLoop</span> function is also updated to reflect the types
change to the <span class="monospaced">route</span> function.</p></div>
<div class="paragraph"><p>With these changes we are able to handle exceptions. If we type in
"buggy" for the request string while running Main4.hs, we will notice
that our request is handled by the <span class="monospaced">errorHandler</span> function.</p></div>
<div class="paragraph"><p>By running <span class="monospaced">main4</span>, and providing <span class="monospaced">buggy</span> as input string, you notice
that the <span class="monospaced">errorHandler</span> is invoked.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">$</span> stack exec main4
<span style="color: #009900">Please</span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> the request
<span style="color: #990000">(</span>one <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> 'handler1'<span style="color: #990000">,</span> 'handler2'<span style="color: #990000">,</span> 'handler3'<span style="color: #990000">,</span> 'buggy' or any string for
<span style="font-weight: bold"><span style="color: #0000FF">default</span></span> handling<span style="color: #990000">)</span>
buggy
<span style="color: #009900">There</span> was an error returned<span style="color: #990000">:</span> <span style="color: #009900">Error</span> from routeHandlerBuggy</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_fifth_iteration">Fifth Iteration</h3>
<div class="paragraph"><p>One thing you will notice is that every <span class="monospaced">routeHandler</span> takes a
<span class="monospaced">String</span> as an argument. This argument will represent the <span class="monospaced">request</span>
information later on in the real <span class="monospaced">Scotty</span> library. A better way to
capture this information would be to wrap it in a type and make the value
available as input to a <span class="monospaced">Reader</span> monad. By wrapping in a new type
we let the <span class="monospaced">Scotty</span> framework process the low level message and
provide request arguments in different forms. In this section, we will
continue to assume that the request parameter is still a
<span class="monospaced">String</span>. But, we will make this value available through a <span class="monospaced">Reader</span>
monad. Replacing the <span class="monospaced">String</span> with some kind of newtype will be
straight forward later on.</p></div>
<div class="paragraph"><p>The entire code for this section is available at
<a href="https://github.com/gdevanla/scotty-from-ground-up/blob/master/app/Main5.hs">Main5.hs</a>.</p></div>
<div class="paragraph"><p>The first thing we do in this iteartion is update the <span class="monospaced">ActionT</span> type.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">ActionT</span> <span style="color: #990000">=</span> Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #009900">ActionError</span> <span style="color: #990000">(</span><span style="color: #009900">Reader</span> <span style="color: #009900">Request</span><span style="color: #990000">)</span> <span style="color: #009900">Response</span></tt></pre></div></div>
<div class="paragraph"><p>From the previous iteration, we replace <span class="monospaced">Either</span> to
<span class="monospaced">ExceptT</span>. <span class="monospaced">ExceptT</span> is a monad transformer that will help wrap the <span class="monospaced">Either</span>
type in a <span class="monospaced">Reader</span> monad. By, switching to <span class="monospaced">ExceptT</span> we are able to use the <span class="monospaced">Reader</span> that
will accept the <span class="monospaced">Request</span> value.</p></div>
<div class="paragraph"><p>Next, we update our <span class="monospaced">client</span> functions the <span class="monospaced">routeHandlers</span> to return
the new <span class="monospaced">ActionT</span> type. Notice, that the signature of all the
<span class="monospaced">routerHandlers</span> change and they no more accept a <span class="monospaced">String</span> as an
argument. The <span class="monospaced">input</span> is retrieved with <span class="monospaced">ask</span>. Here, are the
definitions of the new <span class="monospaced">routerHandlers</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- client functions</span></span>
routeHandler1 <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span>
routeHandler1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input <span style="color: #990000">&lt;-</span> ask
  return <span style="color: #990000">$</span> <span style="color: #FF0000">"middlware_func1 got input = "</span> <span style="color: #990000">++</span> input

routeHandler2 <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span>
routeHandler2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input <span style="color: #990000">&lt;-</span> ask
  return <span style="color: #990000">$</span> <span style="color: #FF0000">"middlware_func2 got input = "</span> <span style="color: #990000">++</span> input

routeHandler3_buggy <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span>
routeHandler3_buggy <span style="color: #990000">=</span> throwError <span style="color: #FF0000">"error from buggy handler"</span>

routeHandler3 <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span>
routeHandler3 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input <span style="color: #990000">&lt;-</span> ask
  return <span style="color: #990000">$</span> <span style="color: #FF0000">"routeHandler3 called = "</span> <span style="color: #990000">++</span> input</tt></pre></div></div>
<div class="paragraph"><p>Notice that the only change we had to make to the <span class="monospaced">routerHandler</span> was
to switch its signature and <span class="monospaced">ask</span> for the <span class="monospaced">input</span> using the
<span class="monospaced">Reader</span> monad.</p></div>
<div class="paragraph"><p>Next, we will look at the changes we need to make to the framework
functions. The change we have to do is to the <span class="monospaced">route</span> and <span class="monospaced">runAction</span>
functions. We have to unwrap the <span class="monospaced">ExceptT</span> monad stack which we will
do in the <span class="monospaced">runAction</span> function.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>route <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Bool</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Route</span>
route mw pat mw1 input_string <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> tryNext <span style="color: #990000">=</span> mw1 input_string <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> pat input_string
  <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> x <span style="color: #990000">=</span> runAction mw input_string
        y <span style="color: #990000">=</span> fromMaybe <span style="color: #FF0000">""</span> x
    <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      y
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    tryNext

runAction <span style="color: #990000">::</span>
  Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #009900">ActionError</span> <span style="color: #990000">(</span><span style="color: #009900">Reader</span> <span style="color: #009900">Request</span><span style="color: #990000">)</span> <span style="color: #009900">Response</span>
  <span style="color: #990000">-&gt;</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span> <span style="color: #009900">String</span>
runAction action request <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> response <span style="color: #990000">=</span> flip runReader request
                 <span style="color: #990000">$</span> Exc<span style="color: #990000">.</span>runExceptT
                 <span style="color: #990000">$</span> action <span style="color: #990000">`</span>catchError<span style="color: #990000">`</span> errorHandler
      left <span style="color: #990000">=</span>  <span style="color: #990000">(\</span>x <span style="color: #990000">-&gt;</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> <span style="color: #990000">(++)</span> <span style="color: #FF0000">"There was an error :"</span> x<span style="color: #990000">)</span>
      right <span style="color: #990000">=</span> <span style="color: #009900">Just</span>
  <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    either left right response</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">runAction</span>  is called from <span class="monospaced">route</span> for the first matching
<span class="monospaced">route</span>. Notice, that we perform the following steps:</p></div>
<div class="paragraph"><p>We run the <span class="monospaced">action</span> using <span class="monospaced">catchError</span> so that any exception raised by
the <span class="monospaced">routerHandlers</span> is processed by the <span class="monospaced">errorHandler</span>. To run the
<span class="monospaced">action</span> we first unwrap it using <span class="monospaced">runExceptT</span>. This gives us the
inner monad which is the <span class="monospaced">Reader</span>. Now we run the <span class="monospaced">Reader</span> monad, by
passing it the <span class="monospaced">request</span> string. Finally, the response is returned as
a <span class="monospaced">Right</span> value if the processing was successful or a <span class="monospaced">Left</span> value if
an error was raised. The <span class="monospaced">errorHandler</span> captures both the <span class="monospaced">input</span> and
the <span class="monospaced">error message</span> that was thrown by one of the route handlers.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>errorHandler <span style="color: #990000">::</span> <span style="color: #009900">String</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span>
errorHandler error <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input <span style="color: #990000">&lt;-</span> ask
  return <span style="color: #990000">$</span> <span style="color: #FF0000">"There was an error returned for input="</span> <span style="color: #990000">++</span> input <span style="color: #990000">++</span> <span style="color: #FF0000">", error="</span> <span style="color: #990000">++</span> error</tt></pre></div></div>
<div class="paragraph"><p>So, with that we are able to wrap our <span class="monospaced">ActionT</span> in a <span class="monospaced">Reader</span> as well
as still retain our <span class="monospaced">Either</span> monad to capture errors as well.</p></div>
</div>
<div class="sect2">
<h3 id="_sixth_iteration">Sixth Iteration</h3>
<div class="paragraph"><p>This will be our last iteration before we start looking at the real
thing. One last thing we want to do is change the type of our
<span class="monospaced">Response</span>. So far we have set the type of <span class="monospaced">Response</span> to be a
<span class="monospaced">String</span>. But, while building a framework, we want to be able to
create layers of middleware where the response can get updated by any
of these layers.  That also allows adding headers and other
information to the response before it is sent to the outside
world. Therefore, that will be the goal of this iteration.</p></div>
<div class="paragraph"><p>The full source for this iteration can be found at
<a href="https://github.com/gdevanla/scotty-from-ground-up/blob/master/app/Main6.hs">Main6.hs</a>.</p></div>
<div class="paragraph"><p>As in the previous iteration, we first update our <span class="monospaced">ActionT</span> type.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">ActionT</span> a <span style="color: #990000">=</span> Exc<span style="color: #990000">.</span><span style="color: #009900">ExceptT</span> <span style="color: #009900">ActionError</span> <span style="color: #990000">(</span><span style="color: #009900">ReaderT</span> <span style="color: #009900">String</span> <span style="color: #990000">(</span>ST<span style="color: #990000">.</span><span style="color: #009900">State</span> <span style="color: #009900">Response</span><span style="color: #990000">))</span> a</tt></pre></div></div>
<div class="paragraph"><p>In contrast to our type in previous interaction, we wrap the <span class="monospaced">Response</span>
in a <span class="monospaced">State</span> monad. And, since we also want to retain our <span class="monospaced">Reader</span>
monad, we update the <span class="monospaced">Reader</span> monad to <span class="monospaced">ReaderT</span> monad which helps us
stack the <span class="monospaced">Reader</span> and <span class="monospaced">State</span> monads. Everyone visualizes these
stacking in different ways, so there is no attempt made here to
describe it! The type of <span class="monospaced">ActionT</span> you see here is almost close to
what <span class="monospaced">Scotty</span> uses. So, it is helpful to review it and understand how
the monads are stacked up.</p></div>
<div class="paragraph"><p>We now need to fix the  <span class="monospaced">runAction</span> from the previous iteration, to
take care of the change to <span class="monospaced">ActionT</span>. All we need to do here is add
<span class="monospaced">runState</span> to the unwrapping statements, since that is the only new
layer we  added. Everything else in <span class="monospaced">runAction</span> remains the same.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>runAction <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span> <span style="color: #009900">Response</span>
runAction action request <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(</span>a<span style="color: #990000">,</span> s<span style="color: #990000">)</span> <span style="color: #990000">=</span> flip ST<span style="color: #990000">.</span>runState <span style="color: #FF0000">""</span>
               <span style="color: #990000">$</span> flip runReaderT request
               <span style="color: #990000">$</span> Exc<span style="color: #990000">.</span>runExceptT
               <span style="color: #990000">$</span> action <span style="color: #990000">`</span>catchError<span style="color: #990000">`</span> errorHandler
      left <span style="color: #990000">=</span> const <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #FF0000">"There was an error"</span>
      right <span style="color: #990000">=</span> const <span style="color: #990000">$</span> <span style="color: #009900">Just</span> s <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    either left right a</tt></pre></div></div>
<div class="paragraph"><p>The changes we need to make to the <span class="monospaced">routerHandlers</span> are a bit
involved. Note, that we <span class="monospaced">ask</span> for the input string the same way we did
in our previous iterations. But, now we need to return a <span class="monospaced">State</span> monad
that accepts a <span class="monospaced">response</span> value as <span class="monospaced">state</span>. Since, the <span class="monospaced">State</span> monad
is tucked away three levels deep in a <span class="monospaced">Reader</span> and then in a <span class="monospaced">Either</span>
monad, we need to apply <span class="monospaced">lift</span> twice. (Note, that in the actual scotty
implementation, the <span class="monospaced">ActionT</span> is a new type and it is an instance of
various <span class="monospaced">Monad</span> classes. Which allows us to skip the explicit applying
of <span class="monospaced">lift</span> operation while using <span class="monospaced">Scotty</span> as the library). Here is the
list of the <span class="monospaced">routeHandlers</span> that go with this iteration.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>routeHandler1 <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">()</span>
routeHandler1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input_string <span style="color: #990000">&lt;-</span> ask
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> st <span style="color: #990000">=</span>
        ST<span style="color: #990000">.</span>modify
        <span style="color: #990000">(\</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="color: #990000">-&gt;</span> constructResponse <span style="color: #990000">[</span><span style="color: #FF0000">"request:"</span> <span style="color: #990000">++</span> input_string<span style="color: #990000">,</span> <span style="color: #FF0000">"processed by routeHandler1"</span><span style="color: #990000">])</span>
  lift <span style="color: #990000">.</span> lift <span style="color: #990000">$</span> st

routeHandler2 <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">()</span>
routeHandler2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input_string <span style="color: #990000">&lt;-</span> ask
  lift <span style="color: #990000">.</span> lift <span style="color: #990000">$</span> ST<span style="color: #990000">.</span>modify  <span style="color: #990000">(\</span>s <span style="color: #990000">-&gt;</span> s <span style="color: #990000">++</span> input_string <span style="color: #990000">++</span> <span style="color: #FF0000">" inside middleware func 2"</span><span style="color: #990000">)</span>

routeHandler3_buggy <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">()</span>
routeHandler3_buggy <span style="color: #990000">=</span> throwError <span style="color: #FF0000">"error from buggy handler"</span>

routeHandler3 <span style="color: #990000">::</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">()</span>
routeHandler3 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  input_string <span style="color: #990000">&lt;-</span> ask
  lift <span style="color: #990000">.</span> lift <span style="color: #990000">$</span> ST<span style="color: #990000">.</span>modify <span style="color: #990000">(\</span>s <span style="color: #990000">-&gt;</span> s <span style="color: #990000">++</span> input_string <span style="color: #990000">++</span> <span style="color: #FF0000">" inside middleware func 3"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>With these changes, we have almost built the skeleton of the framework that
represents the data structures and implementation of <span class="monospaced">Scotty</span>.  With
this understanding, we are ready to go ahead and start studying how the
different parts of <span class="monospaced">Scotty</span> work together.</p></div>
<div class="paragraph"><p>This chapter allowed us to build through a toy framework from very
basic types to some advanced uses of monads. Hopefully, you were able
to walk through this chapter and understand how we went about updating
our coding across different iterations. With this knowledge at hand,
it should be easier to look at the <span class="monospaced">Scotty</span> implementation in the
following chapter. Given that we were able to reason through the
different iterations, the same reasoning can be applied while we read
through the implementation.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sample_web_application">Sample Web Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>We start with a simple web application built using
Scotty. The application will have two end-points. One
end point will return a message formatted in HTML. The second
end point accepts a parameter in the form of a query-string
and embeds it into a dynamically generated HTML string and returns the
result.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>main <span style="color: #990000">::</span> <span style="color: #009900">IO</span> <span style="color: #990000">()</span>
main <span style="color: #990000">=</span> scotty <span style="color: #993399">3000</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  get <span style="color: #FF0000">"/"</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
      html <span style="color: #990000">$</span> <span style="color: #FF0000">"Read you a Scotty!"</span>
  get <span style="color: #FF0000">"/:username"</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    username <span style="color: #990000">&lt;-</span> param <span style="color: #FF0000">"username"</span>
    html <span style="color: #990000">$</span> mconcat <span style="color: #990000">[</span>
         <span style="color: #FF0000">"&lt;h1&gt;Hello, "</span><span style="color: #990000">,</span> username<span style="color: #990000">,</span>  <span style="color: #FF0000">"&lt;/h1&gt;"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Hope you enjoy reading this book"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>We will refer back to this example as we read through the
Scotty implementation. We will also update our example with more
features as we try to reason with some of the approaches taken in the
implementation of Scotty.</p></div>
<div class="paragraph"><p>Let us look closely at this example. In the <span class="monospaced">main</span> function we call
<span class="monospaced">scotty</span> with two arguments. The first argument is the <span class="monospaced">port</span> number
on which we want the web application to listen on. The second argument
to <span class="monospaced">scotty</span> is a value of type <span class="monospaced">ScottyT Text IO</span>. We will look at this
type in detail later. But, for now it is enough to understand that this
wraps a <span class="monospaced">state</span> monad whose state contains the configuration of the
web application. The configuration would be the different HTTP
methods(<span class="monospaced">GET</span>, <span class="monospaced">POST</span>, etc.), the route patterns (<em>/index</em>, <em>/</em>, etc.)
the web application supports. Henceforth, we will refer to this
argument as <span class="monospaced">ScottyT</span> or more generally as <span class="monospaced">scotty state</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">scotty state</span> is built using functions like <span class="monospaced">get</span> <span class="footnote"><br>[other
functions would be <span class="monospaced">post</span>, <span class="monospaced">put</span>, <span class="monospaced">delete</span> etc. Refer to
(<a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty.hs#L238)"><span class="monospaced">Scotty.hs</span>)</a>]<br></span>.
The first argument to <span class="monospaced">get</span> is a string which specifies the <span class="monospaced">url</span>
pattern. The second argument is the more interesting one. The
argument is of type <span class="monospaced">ActionT e m a</span>. The <span class="monospaced">ActionT e m a</span> is a monad
that stacks a few monads under it. Henceforth, we will refer to
this argument as the <span class="monospaced">action</span>. We will continue to use this term to
refer to this argument through this book. More specifically,
throughout this book, we will assume the application is instantiated
with default configuration. Therefore the <span class="monospaced">e</span> in <span class="monospaced">Action T</span> would be
a value of <span class="monospaced">ActionError</span> and <span class="monospaced">m</span> would be the <span class="monospaced">IO</span> monad. The <span class="monospaced">a</span> would vary
depending on the effect of the monad.</p></div>
<div class="paragraph"><p>At the high level, here is what is happening. Each call to <span class="monospaced">get</span>
accepts an <span class="monospaced">url</span> pattern and an <span class="monospaced">action</span> that needs to be performed
if a client request matches the <span class="monospaced">url</span> pattern. Each call to <span class="monospaced">get</span> adds
a <span class="monospaced">route</span> to the <span class="monospaced">scotty state</span>. Therefore, a <span class="monospaced">route</span> contains the
<span class="monospaced">action</span> that has to be performed for a request made to a specific
<span class="monospaced">url</span> pattern. The <span class="monospaced">scotty state</span> contains the list of <span class="monospaced">routes</span>
that it can run every request through until one of the routes
successfully processes the request. In the sample application above we
add two routes to the <span class="monospaced">scotty state</span>. The first <span class="monospaced">route</span> contains the
action,</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
      html <span style="color: #990000">$</span> <span style="color: #FF0000">"Read you a Scotty!"</span></tt></pre></div></div>
<div class="paragraph"><p>and the second route contains the <span class="monospaced">action</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    username <span style="color: #990000">&lt;-</span> param <span style="color: #FF0000">"username"</span>
    html <span style="color: #990000">$</span> mconcat <span style="color: #990000">[</span>
         <span style="color: #FF0000">"&lt;h1&gt;Hello, "</span><span style="color: #990000">,</span> username<span style="color: #990000">,</span>  <span style="color: #FF0000">"&lt;/h1&gt;"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Hope you enjoy reading this book"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>When the request arrives, either the <span class="monospaced">route</span> successfully executes (on
a match) by running the request through the <span class="monospaced">action</span> and returning a
<span class="monospaced">responses</span> or passes the <span class="monospaced">request</span> on to the next <span class="monospaced">route</span> on the
list.  For example, if our request url looked
"http://readyouascotty.com/", then "/" matches our request then the
<span class="monospaced">action</span> which returns "Read you a Scotty!" will be run. Or the next
<span class="monospaced">route</span> is checked and so on.</p></div>
<div class="paragraph"><p>The concept is consistent with any web application one might have
created using other languages/frameworks. Our objective is to wrap
our head around how this whole process is handled in the
implementation. We want to understand what the <span class="monospaced">scotty state</span>
entails. We want to understand why we need <span class="monospaced">ActionT</span>. We will see how
the requests are threaded across different routes, parameters parsed
and errors handled. I hope this helps us identify patterns that we
could use in our own projects.</p></div>
<div class="sect2">
<h3 id="_entry_points_and_settings">Entry Points and Settings</h3>
<div class="paragraph"><p>The scotty app can be configured in a number of ways. All options can
be reviewed at
<a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty.hs#L55">Scotty.hs</a>.</p></div>
<div class="paragraph"><p>Some options available are as follows</p></div>
<div class="ulist"><ul>
<li>
<p>
scotty - This is the simplest. This function takes a port and the
  route handlers we will be looking at shortly
</p>
</li>
<li>
<p>
scottyOpts - This function provides more options to run the
  scotty app. The <span class="monospaced">warp</span> server is the backend for <span class="monospaced">Scotty</span>.
</p>
</li>
<li>
<p>
scottySocket - To run the Scotty app by listening to the warp server
  on an Unix socket.
</p>
</li>
<li>
<p>
scottyApp - This is more to turn the application into another
  middleware of an WAI application which can be used by any handler. The
  <span class="monospaced">WAI</span> library can be viewed as the middleware siting between <span class="monospaced">Scotty</span>
  and the <span class="monospaced">warp</span> server.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These functions are wrappers around the functions in
<a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Trans.hs#L63">Trans.hs</a>. We
will look at these functions in detail in later chapters.</p></div>
<div class="paragraph"><p>Next, we will look at the data type that can be used to
configure the server.  As stated earlier, the scottyOpts function take
a value of <span class="monospaced">Options</span> record data type. The <span class="monospaced">Options</span> data type is declared in
<a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L41">Types.hs</a></p></div>
<div class="listingblock">
<div class="title">Options</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">Options</span> <span style="color: #990000">=</span> <span style="color: #009900">Options</span> <span style="color: #990000">{</span> verbose <span style="color: #990000">::</span> <span style="color: #009900">Int</span>
                       <span style="color: #990000">,</span> settings <span style="color: #990000">::</span> <span style="color: #009900">Settings</span> <span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">settings</span> attribute holds the warp server settings. The app
settings is an abstract data type that can be accessed through the
provided default constructor and a group of setter methods as defined
under
<a href="https://hackage.haskell.org/package/warp-3.2.11/docs/Network-Wai-Handler-Warp.html#v:defaultSettings">warp
settings</a></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="routes">Declaring routes</h2>
<div class="sectionbody">
<div class="paragraph"><p>From the sample web application, we see that the third parameter to
the <span class="monospaced">scotty</span> function is a list of actions that needs to be performed
if the request matches the route pattern specified as the second
argument. Every time a request needs to be processed, we want to be
able to match the request to the <span class="monospaced">url</span> pattern and use the respective
<span class="monospaced">action</span> to process the request. Therefore, we want want to wrap each
action in a <span class="monospaced">route</span>. Hence we create a set of routes to handle request to
different <span class="monospaced">url</span> patterns. We will store this information in the
<span class="monospaced">scotty state</span>.</p></div>
<div class="paragraph"><p>We want any client of Scotty to be able to create a route handler for each
route pattern. One way we can do that is to thread the request through
a list of routes handlers until one of the routes wraps an action that
succeeds. Every route handler should take a <span class="monospaced">Request</span> type and return some <span class="monospaced">m
Response</span> type (eg. IO Response). We also want to thread our requests to the next
route handler. Therefore, we a need to create a  <span class="monospaced">route</span> value whose
type would be to process a <span class="monospaced">request</span> using a particular <span class="monospaced">action</span>
and also accept another <span class="monospaced">route</span> handler that can be used if the <span class="monospaced">request</span>
cannot be processed with the given action.</p></div>
<div class="paragraph"><p>Therefore, we would end up with a type that looks conceptually
as follows. Notice, that return value is still of type <span class="monospaced">Response</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Response</span></tt></pre></div></div>
<div class="paragraph"><p>This is exactly the kind of type we built upon in the toy <span class="monospaced">Scotty</span>
framework we built.</p></div>
<div class="paragraph"><p>Let us now walk through some of the real types that help us build these
states.</p></div>
<div class="listingblock">
<div class="title"><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L54">Application and Middleware</a></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">-----</span> <span style="color: #009900">Transformer</span> <span style="color: #009900">Aware</span> <span style="color: #009900">Applications</span><span style="color: #990000">/</span><span style="color: #009900">Middleware</span> <span style="color: #990000">-----</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Middleware</span> m <span style="color: #990000">=</span> <span style="color: #009900">Application</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Application</span> m
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Application</span> m <span style="color: #990000">=</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span></tt></pre></div></div>
<div class="paragraph"><p>These two types hide the <span class="monospaced">Application</span> and <span class="monospaced">Middleware</span> types from
<span class="monospaced">Network.Wai</span>. <span class="monospaced">Network.Wai</span> is the backend interface to a library
like <span class="monospaced">warp</span>. The <span class="monospaced">Application</span> type is self-explanatory. It is a
function takes a <span class="monospaced">Request</span> and returns a <span class="monospaced">Response</span> wrapped in some
monad <span class="monospaced">m</span>. The default <span class="monospaced">Application</span> type provided by <span class="monospaced">Network.Wai</span>
has this type,</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Application</span> <span style="color: #990000">=</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Response</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">ResponseReceived</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">ResponseReceived</span></tt></pre></div></div>
<div class="paragraph"><p>The reason why Scotty abstracts over this type will become clearer
later on. For now, it is sufficient to understand that with the local
<span class="monospaced">Application</span> type Scotty can wrap the <span class="monospaced">Response</span> in a stack of monads
that will abstract away some of the error handling that would be
required. Notice, this <span class="monospaced">Application</span> type differs from our toy
example. This is due some redirection introduced by <span class="monospaced">Network.Wai</span>
library to control the <span class="monospaced">ResponseReceived</span> values returned by each <span class="monospaced">Application</span>.</p></div>
<div class="paragraph"><p>Scotty also declares a <span class="monospaced">Middleware</span> type. This type is an example of
continuation-passing style where a value of type <span class="monospaced">Middleware</span> takes an
<span class="monospaced">Application</span> and then decides to delegate the call to its second
parameter which happens to be another <span class="monospaced">Application</span>. Using, this
pattern we can thread a request through different <span class="monospaced">Application</span> values
until the request in successfully processed. This type also gives
Scotty the ability to thread a request through a pipeline of
<span class="monospaced">Middleware</span> values. The <span class="monospaced">route</span> value we were looking for in the
earlier will be a example of <span class="monospaced">Middleware</span> value. With the initial
setup of our sample application, we end up with a list of routes which
are of type <span class="monospaced">[Middleware m]</span>. Note, that this type aligns with the
type the <span class="monospaced">route</span> function in the toy example was using.</p></div>
<div class="paragraph"><p>Let us now see how the above two types are used.</p></div>
<div class="listingblock">
<div class="title"><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#58">Types.hs</a></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="color: #990000">---------------</span> <span style="color: #009900">Scotty</span> <span style="color: #009900">Applications</span> <span style="color: #990000">-----------------</span>
<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">ScottyState</span> e m <span style="color: #990000">=</span>
    <span style="color: #009900">ScottyState</span> <span style="color: #990000">{</span> middlewares <span style="color: #990000">::</span> <span style="color: #990000">[</span>Wai<span style="color: #990000">.</span><span style="color: #009900">Middleware</span><span style="color: #990000">]</span>
                <span style="color: #990000">,</span> routes <span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">Middleware</span> m<span style="color: #990000">]</span>
                <span style="color: #990000">,</span> handler <span style="color: #990000">::</span> <span style="color: #009900">ErrorHandler</span> e m
                <span style="color: #990000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>In this chapter we will focus on the <span class="monospaced">routes</span> attribute. The routes
attribute is a list of routes that Scotty needs to thread every
request through till the request is successfully processed. As we
discussed earlier, another way to look at the type of one element of
<span class="monospaced">routes</span> would be</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>route<span style="color: #990000">::</span> <span style="color: #009900">Middleware</span> m

route<span style="color: #990000">::</span> <span style="color: #009900">Application</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Application</span> m

route <span style="color: #990000">::</span>  <span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span><span style="color: #990000">)</span>

route <span style="color: #990000">::</span>  <span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span>
</tt></pre></div></div>
<div class="paragraph"><p>So, we see that an element of <span class="monospaced">routes</span> is a type that take a function
that turns a <span class="monospaced">Request</span> into <span class="monospaced">m Response</span>. In the process, it also
receives another function as a continuation that can be used if the
first function argument cannot process the request successfully. The
tricky thing to observe for a some of us would be to see that the
final return value of this function in still <span class="monospaced">m Response</span>, even
though the above organization makes it look like a <span class="monospaced">Middleware</span>
value is returned. We specifically state the return value of this
function is <span class="monospaced">m Response</span>, since that is what is required to interact
with the <span class="monospaced">Network.Wai</span> layer.</p></div>
<div class="paragraph"><p>How does Scotty configure these routes? Lets take a look at a
<span class="monospaced">Hello, Scotty</span> app.  The third parameter to the <span class="monospaced">scotty</span> function is a
monad. More specifically, it is a State monad of type</p></div>
<div class="listingblock">
<div class="title"><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#74">ScottyT</a></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">newtype</span></span> <span style="color: #009900">ScottyT</span> e m a <span style="color: #990000">=</span> <span style="color: #009900">ScottyT</span> <span style="color: #990000">{</span> runS <span style="color: #990000">::</span> <span style="color: #009900">State</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyState</span> e m<span style="color: #990000">)</span> a <span style="color: #990000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">deriving</span></span> <span style="color: #990000">(</span> <span style="color: #009900">Functor</span><span style="color: #990000">,</span> <span style="color: #009900">Applicative</span><span style="color: #990000">,</span> <span style="color: #009900">Monad</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Scotty uses this state monad to register the list of actions, where
each action is wrapped in one route. For example every action listed
in the third argument to <span class="monospaced">scotty</span> function returns a <span class="monospaced">ScottyT
e m a</span> and the state monad captures all the actions in its
state.</p></div>
<div class="paragraph"><p>Let us take a look at how this is done.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  get <span style="color: #FF0000">"/:word"</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
          beam <span style="color: #990000">&lt;-</span> param <span style="color: #FF0000">"word"</span>
                  html <span style="color: #990000">$</span> mconcat <span style="color: #990000">[</span><span style="color: #FF0000">"&lt;h1&gt;Scotty, "</span><span style="color: #990000">,</span> beam<span style="color: #990000">,</span> <span style="color: #FF0000">" me up!&lt;/h1&gt;"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">get</span> function resolves to <span class="monospaced">addroute GET</span> function in</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Route.hs#30">get</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-style: italic"><span style="color: #9A1900">-- | get = 'addroute' 'GET'</span></span>
get <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ScottyT</span> e m <span style="color: #990000">()</span>
get <span style="color: #990000">=</span> addroute <span style="color: #009900">GET</span>
</tt></pre></div></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Route.hs#67">addroute</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-style: italic"><span style="color: #9A1900">-- | Define a route with a 'StdMethod', 'T.Text' value representing the path spec,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- and a body ('Action') which modifies the response.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- &gt; addroute GET "/" $ text "beam me up!"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- The path spec can include values starting with a colon, which are interpreted</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- as /captures/. These are named wildcards that can be looked up with 'param'.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- &gt; addroute GET "/foo/:bar" $ do</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- &gt;     v &lt;- param "bar"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- &gt;     text v</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- &gt;&gt;&gt; curl http://localhost:3000/foo/something</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- something</span></span>
addroute <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">StdMethod</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ScottyT</span> e m <span style="color: #990000">()</span>
addroute method pat action <span style="color: #990000">=</span> <span style="color: #009900">ScottyT</span> <span style="color: #990000">$</span> MS<span style="color: #990000">.</span>modify <span style="color: #990000">$</span> <span style="color: #990000">\</span>s <span style="color: #990000">-&gt;</span> addRoute <span style="color: #990000">(</span>route <span style="color: #990000">(</span>handler s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #009900">Just</span> method<span style="color: #990000">)</span> pat action<span style="color: #990000">)</span> s
</tt></pre></div></div>
<div class="paragraph"><p>The core function to understand is the <span class="monospaced">addRoute</span> function. The
function takes a <span class="monospaced">StdMethod</span> which specifies one of the Http
request methods. The second parameter is the route pattern. For
example "/index" or "/:name" etc. The third parameter is the action
that is going to be performed for the given request. Notice that each
each action is wrapped inside a route closure. This is the parameter that is
provided as the second parameter to <span class="monospaced">get</span> as an <span class="monospaced">action</span> value.</p></div>
<div class="paragraph"><p>Lets look closely at the <span class="monospaced">addroute</span> function. It returns <span class="monospaced">ScottyT</span>
object which is the state monad that wraps the <span class="monospaced">ScottyState</span>. The
computation is the state monad is just weaving the state through
<span class="monospaced">modify</span>. <span class="monospaced">modify</span> accepts a function whose first argument accepts a <span class="monospaced">state</span> and
returns a modified <span class="monospaced">state</span>. So, what is this function doing?</p></div>
<div class="paragraph"><p>The function provided to <span class="monospaced">modify</span>, adds a route to the
ScottyState.routes attributes. Recollect, that the each route is of
type <span class="monospaced">Middleware m</span>. That is, it takes a (Request &#8594; m Response) and a
fallback (Request &#8594; m Response). The <span class="monospaced">route</span> function creates the
request <span class="monospaced">Middleware m</span> that gets added as a <span class="monospaced">route</span> to <span class="monospaced">ScottyState</span>.</p></div>
<div class="paragraph"><p>We will look at the <span class="monospaced">route</span> function in detail later on. But for now
it is enough to understand that the <span class="monospaced">route</span> function wraps the <span class="monospaced">action</span>
that needs to be performed for the request. For the novice haskeller,
this a great example of power of currying. We seamlessly, create a
<span class="monospaced">route</span> value, by providing just the first 4 parameters. The only
remaining parameter to this function is <span class="monospaced">Middleware m</span>. When this
function gets called later, the <span class="monospaced">Application</span> (which happens to be the
next <span class="monospaced">route</span> in the list of <span class="monospaced">routes</span> and the <span class="monospaced">Request</span> object are
provided. Therefore, the types check out.  Take a minute and reason
how the <span class="monospaced">addRoute</span> function returns a value of type <span class="monospaced">Middleware m</span>
when called inside the <span class="monospaced">State</span> monad. Then think about how a <span class="monospaced">Request</span>
and <span class="monospaced">Application m</span> can be passed to this function at a later time.</p></div>
<div class="listingblock">
<div class="title"><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Route.hs#67">route</a></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>route <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ErrorHandler</span> e m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span> <span style="color: #009900">StdMethod</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Middleware</span> m
route h method pat action app req <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> tryNext <span style="color: #990000">=</span> app req
        <span style="font-style: italic"><span style="color: #9A1900">{- |</span></span>
<span style="font-style: italic"><span style="color: #9A1900">          We match all methods in the case where 'method' is 'Nothing'.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">          See https://github.com/scotty-web/scotty/issues/196</span></span>
<span style="font-style: italic"><span style="color: #9A1900">        -}</span></span>
        methodMatches <span style="color: #990000">::</span> <span style="color: #009900">Bool</span>
        methodMatches <span style="color: #990000">=</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> method <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
                <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">True</span>
                <span style="color: #009900">Just</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Right</span> m <span style="color: #990000">==</span> parseMethod <span style="color: #990000">(</span>requestMethod req<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> methodMatches
       <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> matchRoute pat req <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
            <span style="color: #009900">Just</span> captures <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
                env <span style="color: #990000">&lt;-</span> mkEnv req captures
                res <span style="color: #990000">&lt;-</span> runAction h env action
                maybe tryNext return res
            <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> tryNext
       <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> tryNext
</tt></pre></div></div>
<div class="paragraph"><p>Now, looking closely, when the <span class="monospaced">route</span> gets added to the list of
<span class="monospaced">routes</span>, the parameters provided to this function are <span class="monospaced">ErrorHandler e
m</span>, <span class="monospaced">Maybe StdMethod</span>, <span class="monospaced">RouterPattern</span>, <span class="monospaced">ActionT e m</span>. The remaining
parameters are provided when the client requests arrive. When the
client requests arrive, first the <span class="monospaced">ActionT e m ()</span> value is run using
<span class="monospaced">runAction</span> and if that action fails, then <span class="monospaced">tryNext</span> is called which
passes the <span class="monospaced">Request</span> on to the next <span class="monospaced">Application</span>. The next handler
could be any <span class="monospaced">Middleware m</span> (that is another <span class="monospaced">route</span> or an arbitrary
middlware).</p></div>
<div class="paragraph"><p>One way to understood the type of this function, is to flatten it out
as follows</p></div>
<div class="listingblock">
<div class="title">Resolving the types of <span class="monospaced">route</span></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
route <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ErrorHandler</span> e m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span>
<span style="color: #009900">StdMethod</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Middleware</span> m

route <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ErrorHandler</span> e m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span>
<span style="color: #009900">StdMethod</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Application</span> m <span style="color: #990000">-&gt;</span>
<span style="color: #009900">Application</span> m<span style="color: #990000">).</span>

route <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ErrorHandler</span> e m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span>
<span style="color: #009900">StdMethod</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span>  m <span style="color: #009900">Response</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
<span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span><span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>Therefore, using the flattened type signature, we see that</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
When <span class="monospaced">route</span> is added to the <span class="monospaced">routes</span> attribute, we add a
           curried function of type <span class="monospaced">(Request -&gt; m Response -&gt; Request -&gt; m
           Response)</span>.
</p>
</li>
<li>
<p>
When the request actually has to be processed, the curried function
           is then invoked with the next <span class="monospaced">route</span> in the list that happens to be
           of type <span class="monospaced">Middleware</span>. But, when all <span class="monospaced">middlewares</span> are applied, the
           final type resolves to type <span class="monospaced">Request -&gt; m Response</span>.
</p>
</li>
<li>
<p>
Now the function is applied to a <span class="monospaced">Request</span>
           value. The <span class="monospaced">runAction</span> on the request either succeeds or on
           failure, the <span class="monospaced">Request</span> is passed on to next <span class="monospaced">Application
           m</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In this section, we explored how the third parameter we passed to
<span class="monospaced">scotty</span> function is used to configure a list of routes, which each
route captures the <span class="monospaced">url</span> pattern of the requests it can service and
the <span class="monospaced">action</span> that needs to be applied to the requests when the <span class="monospaced">url</span>
pattern matches. This also aligns with toy scotty we built using a
similar <span class="monospaced">route</span> function.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_initializing_the_app">Initializing the App</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the previous chapter, we looked at how the routes get built when the entry
point of our app is called.</p></div>
<div class="paragraph"><p>So far, all the statements under <span class="monospaced">do [expression]</span> which was the third
parameter to the <span class="monospaced">scotty</span> function has been evaluated and all routes
added to the state of the <span class="monospaced">ScottyT e m a</span>. For our purpose, this type
resolved to <span class="monospaced">ScottyT e IO ()</span>. The <span class="monospaced">e</span> is for error-handling and we
will take a look at it later.</p></div>
<div class="paragraph"><p>If you are interested in the call trace so far, here it is</p></div>
<div class="paragraph"><p>Scotty.scotty &#8594; Trans.scottyT &#8594; Trans.scottyOpsT.</p></div>
<div class="paragraph"><p>Now, let us take a look at scottyOpsT where our web application starts
listening and serving requests.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Trans.hs#L70">ScottyOpsT</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- | Run a scotty application using the warp server, passing extra options.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- NB: scottyOpts opts === scottyOptsT op</span></span>
scotidtyOptsT <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">Monad</span> m<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> n<span style="color: #990000">)</span>
            <span style="color: #990000">=&gt;</span> <span style="color: #009900">Options</span>
            <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>m <span style="color: #009900">Response</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">Response</span><span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">-- ^ Run monad 'm' into 'IO', called at each action.</span></span>
            <span style="color: #990000">-&gt;</span> <span style="color: #009900">ScottyT</span> e m <span style="color: #990000">()</span>
            <span style="color: #990000">-&gt;</span> n <span style="color: #990000">()</span>
scottyOptsT opts runActionToIO s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
      when <span style="color: #990000">(</span>verbose opts <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #990000">$</span>
              liftIO <span style="color: #990000">$</span> putStrLn <span style="color: #990000">$</span> <span style="color: #FF0000">"Setting phasers to stun... (port "</span> <span style="color: #990000">++</span> show <span style="color: #990000">(</span>getPort <span style="color: #990000">(</span>settings opts<span style="color: #990000">))</span> <span style="color: #990000">++</span> <span style="color: #FF0000">") (ctrl-c to quit)"</span>
    liftIO <span style="color: #990000">.</span> runSettings <span style="color: #990000">(</span>settings opts<span style="color: #990000">)</span> <span style="color: #990000">=&lt;&lt;</span> scottyAppT runActionToIO s
</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">runSettings</span> function is from <span class="monospaced">Network.Wai.Handler.Warp</span>. Its
type is</p></div>
<div class="paragraph"><p><a href="https://hackage.haskell.org/package/warp-3.2.11.1/docs/src/Network-Wai-Handler-Warp-Run.html#runSettings">runSettings</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>runSettings <span style="color: #990000">::</span> <span style="color: #009900">Settings</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Application</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">(settings opts)</span> returns the <span class="monospaced">Settings</span> value. We looked at the
the <span class="monospaced">Options</span> record type in <span class="monospaced">Types.hs</span> earlier.</p></div>
<div class="paragraph"><p><span class="monospaced">runSettings</span> is first called with <span class="monospaced">settings</span>. The second parameter to
<span class="monospaced">runSettings</span> is</p></div>
<div class="paragraph"><p><a href="http://hackage.haskell.org/package/wai-3.2.1.1/docs/Network-Wai.html#t:Application">Network.Wai.Application</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Application</span> <span style="color: #990000">=</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Response</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">ResponseReceived</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">ResponseReceived</span></tt></pre></div></div>
<div class="paragraph"><p>We build this value using <span class="monospaced">scottyAppT runActionIO s</span>. The
<span class="monospaced">runActionIO</span> is set to <span class="monospaced">id</span> and <span class="monospaced">s</span> is the value of <span class="monospaced">ScottyT e m ()</span>
which is the state of the web application.  Now, we turn our attention
to <span class="monospaced">scottyAppT</span> tht will produce the `Application value needed.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- | Turn a scotty application into a WAI 'Application', which can be</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- run with any WAI handler.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- NB: scottyApp === scottyAppT id</span></span>
scottyAppT <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">Monad</span> m<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> n<span style="color: #990000">)</span>
           <span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>m <span style="color: #009900">Response</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">Response</span><span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">-- ^ Run monad 'm' into 'IO', called at each action.</span></span>
           <span style="color: #990000">-&gt;</span> <span style="color: #009900">ScottyT</span> e m <span style="color: #990000">()</span>
           <span style="color: #990000">-&gt;</span> n <span style="color: #009900">Application</span>
scottyAppT runActionToIO defs <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> s <span style="color: #990000">=</span> execState <span style="color: #990000">(</span>runS defs<span style="color: #990000">)</span> def
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> rapp req callback <span style="color: #990000">=</span> runActionToIO <span style="color: #990000">(</span>foldl <span style="color: #990000">(</span>flip <span style="color: #990000">($))</span> notFoundApp <span style="color: #990000">(</span>routes s<span style="color: #990000">)</span> req<span style="color: #990000">)</span> <span style="color: #990000">&gt;&gt;=</span> callback
    return <span style="color: #990000">$</span> foldl <span style="color: #990000">(</span>flip <span style="color: #990000">($))</span> rapp <span style="color: #990000">(</span>middlewares s<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>As a first step, we <span class="monospaced">execState</span> of <span class="monospaced">ScottyT e m()</span>. This creates all
the <span class="monospaced">routes</span> that were declared in our app. Recollect, the <span class="monospaced">execState</span>
invokes the state monad <span class="monospaced">ScottyT e m()</span> that was returned by
consecutive calls to <span class="monospaced">addroute</span> as each of our <span class="monospaced">do &lt;expressions&gt;</span> were
evaluated. This statement evaluates the <span class="monospaced">route</span> function we looked at
in the previous chapter.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> s <span style="color: #990000">=</span> execState <span style="color: #990000">(</span>runS defs<span style="color: #990000">)</span> def</tt></pre></div></div>
<div class="paragraph"><p>Now we need to return a function that ultimately takes a
<span class="monospaced">Request</span> and returns a <span class="monospaced">m Response</span>. In other words it is the
<span class="monospaced">Application m</span> type we have in <span class="monospaced">Types.hs</span>.</p></div>
<div class="paragraph"><p>There are a couple of things we need to have. We want to thread
a <span class="monospaced">Request</span> through all the <span class="monospaced">routes. Once one of the `routes</span> returns
a <span class="monospaced">IO Response</span>, we will have to apply all middlewares in the same
order they appear in the list.  Therefore, we do two things, we
defined a function <span class="monospaced">rapp</span> which is of the following type</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>rapp<span style="color: #990000">::</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">Response</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">ResponseRecieved</span><span style="color: #990000">)</span>
rapp req callback <span style="color: #990000">=</span> <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>When we fold over all the user defined routes and middleware we want something like</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">M1</span> <span style="color: #990000">$</span> <span style="color: #990000">(</span> <span style="color: #009900">M2</span> <span style="color: #990000">$</span> <span style="color: #990000">...</span><span style="color: #009900">Mn</span> <span style="color: #990000">($</span> <span style="color: #990000">(</span> rapp <span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>And then <span class="monospaced">rapp</span> expands to</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">M1</span> <span style="color: #990000">$</span> <span style="color: #990000">(</span> <span style="color: #009900">M2</span> <span style="color: #990000">$</span> <span style="color: #990000">...</span><span style="color: #009900">Mn</span> <span style="color: #990000">($</span> <span style="color: #990000">(</span> <span style="color: #009900">R1</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">R2</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">....-&gt;</span> notFoundApp<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>where R1, R2, ..Rn are the list of routes of type
Middleware m.  And since <span class="monospaced">rapp</span> takes two other parameters, the
returned type from scottyAppT is a function that takes the  <span class="monospaced">Request</span> and
returns <span class="monospaced">Response m</span>. And since we run this whole function in a IO
Monad in our case, we get back</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">IO</span> <span style="color: #990000">(</span><span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">IO</span> <span style="color: #009900">Response</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">-- which can also be written asciidoc</span></span>
<span style="color: #009900">IO</span> <span style="color: #990000">(</span><span style="color: #009900">Application</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">-- and replacing with generic monad, we have</span></span>
n <span style="color: #009900">Application</span></tt></pre></div></div>
<div class="paragraph"><p>Now, going back to <span class="monospaced">scottyOptsT</span>, where we had a call to <span class="monospaced">scottyAppT</span>, we
apply <span class="monospaced">runSettings (settings opts)</span> to the its return value <span class="monospaced">IO Application</span>.</p></div>
<div class="paragraph"><p>Therefore, using <span class="monospaced">scottyOptsT</span> we were able to initialize the <span class="monospaced">Network.Wai</span> interface
to start listening to user requests.</p></div>
<div class="paragraph"><p>The core of the initialization happens in the <span class="monospaced">scottyAppT</span> or one of
its variants in the <span class="monospaced">Scotty</span> library.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_handling_requests">Handling requests</h2>
<div class="sectionbody">
<div class="paragraph"><p>So far we have seen how we set up the state of a <span class="monospaced">Scotty</span> app and then also
studied how the <span class="monospaced">web app</span> is started before it starts serving requests.</p></div>
<div class="paragraph"><p>One important thing to recollect that we learned during this process
was the <span class="monospaced">Scotty</span> state updates itself with the list of routes as
defined in the declaration of the web app. Each of the routes that are
defined is a function that contains the <span class="monospaced">action</span> that needs to be
performed once the incoming <span class="monospaced">Request</span> for  a route matches the
pre-defined routes.</p></div>
<div class="paragraph"><p>There are 2 important functions that handles this process. We already
saw one function in the chapter on <a href="#routes">routes</a> where we briefly
talked about <span class="monospaced">route</span> function. This was the function that captured
the <span class="monospaced">action</span> that was provided for each <span class="monospaced">route</span>. The second function
we will discuss will be <span class="monospaced">runAction</span>.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at each of these functions.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Route.hs#L67">Routes.hs</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>route <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ErrorHandler</span> e m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Maybe</span> <span style="color: #009900">StdMethod</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">RoutePattern</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Middleware</span> m
route h method pat action app req <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> tryNext <span style="color: #990000">=</span> app req
        methodMatches <span style="color: #990000">::</span> <span style="color: #009900">Bool</span>
        methodMatches <span style="color: #990000">=</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> method <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
                <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">True</span>
                <span style="color: #009900">Just</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Right</span> m <span style="color: #990000">==</span> parseMethod <span style="color: #990000">(</span>requestMethod req<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> methodMatches
       <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> matchRoute pat req <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
            <span style="color: #009900">Just</span> captures <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
                env <span style="color: #990000">&lt;-</span> mkEnv req captures
                res <span style="color: #990000">&lt;-</span> runAction h env action
                maybe tryNext return res
            <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> tryNext
       <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> tryNext</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">route</span> function is called during the setting up of <span class="monospaced">routes</span>
attribute of <span class="monospaced">ScottyState</span> data type. This function is called for each
route that is declared in our web application. The function is initially
called with an <span class="monospaced">ErrorHandler e m</span> (attribute of ScottyState), the
<span class="monospaced">StdMethod</span> value (the request type <span class="monospaced">GET</span>, <span class="monospaced">POST</span> etc), the
<span class="monospaced">RoutePattern</span> (the patterns like <em>/index</em>), and the <span class="monospaced">action</span> of type
<span class="monospaced">ActionT e m()</span>. We will look that <span class="monospaced">ActionT e m ()</span> when we discuss
<span class="monospaced">runAction</span>.  Once, these three arguments are applied, we have a
function type <span class="monospaced">Middleware m</span>.</p></div>
<div class="paragraph"><p>This is the function that will be called while processing each
request as we look through each route to satisfy a request. In other
words, the list of these functions form the list of <span class="monospaced">routes</span> or list
of <span class="monospaced">Middleware m</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">route</span> function, when called checks if the request method and
route pattern match what the given action can process. On a match, first the the
<span class="monospaced">Request</span> value <span class="monospaced">req</span> is parsed using <span class="monospaced">mkEnv</span> into the <span class="monospaced">ActionEnv</span>
type.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L109">ActionEnv</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">ActionEnv</span> <span style="color: #990000">=</span> <span style="color: #009900">Env</span> <span style="color: #990000">{</span> getReq       <span style="color: #990000">::</span> <span style="color: #009900">Request</span>
                     <span style="color: #990000">,</span> getParams    <span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">Param</span><span style="color: #990000">]</span>
                     <span style="color: #990000">,</span> getBody      <span style="color: #990000">::</span> <span style="color: #009900">IO</span> <span style="color: #009900">ByteString</span>
                     <span style="color: #990000">,</span> getBodyChunk <span style="color: #990000">::</span> <span style="color: #009900">IO</span> BS<span style="color: #990000">.</span><span style="color: #009900">ByteString</span>
                     <span style="color: #990000">,</span> getFiles     <span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">File</span><span style="color: #990000">]</span>
                     <span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Recollect, that the function type of <span class="monospaced">route</span> function at this point is
<span class="monospaced">Middleware m</span>. That is</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">Application</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Application</span> m
<span style="font-style: italic"><span style="color: #9A1900">-- that expands out to</span></span>
<span style="color: #009900">Application</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">Response</span></tt></pre></div></div>
<div class="paragraph"><p>Once, we have the request parsed, we run the request through the
<span class="monospaced">ActionT e m()</span>. If running the <span class="monospaced">ActionT e m</span> succeeds, we return, or
else we pass the request on to the next <span class="monospaced">Application m</span>. This
continues until the request can be satisfied or until the <span class="monospaced">notFound</span>
value is found. Note that the <span class="monospaced">notFound</span> value is the last
<span class="monospaced">Application</span> value attached in the <span class="monospaced">scottyAppT `. That allows the
`types</span> to check out and finally have a function that takes a
<span class="monospaced">Request</span> and returns a <span class="monospaced">m Response</span>.</p></div>
<div class="paragraph"><p>We will shortly turn our attention to 'runAction` function. Before, that we
will look closely at <span class="monospaced">ActionT e m ()</span></p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L138">ActionT
e m a</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">newtype</span></span> <span style="color: #009900">ActionT</span> e m a <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">{</span> runAM <span style="color: #990000">::</span> <span style="color: #009900">ExceptT</span> <span style="color: #990000">(</span><span style="color: #009900">ActionError</span> e<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #009900">ReaderT</span> <span style="color: #009900">ActionEnv</span> <span style="color: #990000">(</span><span style="color: #009900">StateT</span> <span style="color: #009900">ScottyResponse</span> m<span style="color: #990000">))</span> a <span style="color: #990000">}</span>
            <span style="font-weight: bold"><span style="color: #0000FF">deriving</span></span> <span style="color: #990000">(</span> <span style="color: #009900">Functor</span><span style="color: #990000">,</span> <span style="color: #009900">Applicative</span><span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Let us unwrap this transformer stack. Refering back to the toy
application may help at this point! The <span class="monospaced">ScottyResponse</span> type</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L126">ScottyResponse</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">ScottyResponse</span> <span style="color: #990000">=</span> <span style="color: #009900">SR</span> <span style="color: #990000">{</span> srStatus  <span style="color: #990000">::</span> <span style="color: #009900">Status</span>
                         <span style="color: #990000">,</span> srHeaders <span style="color: #990000">::</span> <span style="color: #009900">ResponseHeaders</span>
                         <span style="color: #990000">,</span> srContent <span style="color: #990000">::</span> <span style="color: #009900">Content</span>
                         <span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This type packs the response that is delivered across the <span class="monospaced">Middleware
m</span> values as the request is processed by each middleware. This is
similar to the simpler <span class="monospaced">Response</span> type we had in out toy application.</p></div>
<div class="paragraph"><p>The <span class="monospaced">a</span> usually will be <span class="monospaced">()</span> since each <span class="monospaced">action</span> updates the <span class="monospaced">state</span>
which is the <span class="monospaced">ScottyResponse</span>. This is discussed in the next chapter.</p></div>
<div class="paragraph"><p>The <span class="monospaced">StateT</span> object is run inside <span class="monospaced">ReaderT</span> and the <span class="monospaced">Reader</span> monad
makes the <span class="monospaced">ActionEnv</span> value available to the <span class="monospaced">action</span>. In our web
application, we use the <span class="monospaced">param</span> function to access the parameters that
are submitted along with the request. The <span class="monospaced">param</span> function wraps the
<span class="monospaced">ask</span> functions of the <span class="monospaced">Reader</span> monad. We will explore the code that
parses the params seperately. <span class="monospaced">ExceptT</span> wraps the action and also a
error value <span class="monospaced">ActionError e</span> if the processing of the response fails.</p></div>
<div class="paragraph"><p>The use of this value is best understood by its use in the <span class="monospaced">runAction</span> function.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L138">Action
T e m a</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">newtype</span></span> <span style="color: #009900">ActionT</span> e m a <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">{</span> runAM <span style="color: #990000">::</span> <span style="color: #009900">ExceptT</span> <span style="color: #990000">(</span><span style="color: #009900">ActionError</span> e<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #009900">ReaderT</span> <span style="color: #009900">ActionEnv</span> <span style="color: #990000">(</span><span style="color: #009900">StateT</span> <span style="color: #009900">ScottyResponse</span> m<span style="color: #990000">))</span> a <span style="color: #990000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">deriving</span></span> <span style="color: #990000">(</span> <span style="color: #009900">Functor</span><span style="color: #990000">,</span> <span style="color: #009900">Applicative</span><span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L63">runAction</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- Nothing indicates route failed (due to Next) and pattern matching should continue.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- Just indicates a successful response.</span></span>
runAction <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ErrorHandler</span> e m <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionEnv</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> m <span style="color: #990000">(</span><span style="color: #009900">Maybe</span> <span style="color: #009900">Response</span><span style="color: #990000">)</span>
runAction h env action <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    <span style="color: #990000">(</span>e<span style="color: #990000">,</span>r<span style="color: #990000">)</span> <span style="color: #990000">&lt;-</span> flip MS<span style="color: #990000">.</span>runStateT def
           <span style="color: #990000">$</span> flip runReaderT env
           <span style="color: #990000">$</span> runExceptT
           <span style="color: #990000">$</span> runAM
           <span style="color: #990000">$</span> action <span style="color: #990000">`</span>catchError<span style="color: #990000">`</span> <span style="color: #990000">(</span>defH h<span style="color: #990000">)</span>
    return <span style="color: #990000">$</span> either <span style="color: #990000">(</span>const <span style="color: #009900">Nothing</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>const <span style="color: #990000">$</span> <span style="color: #009900">Just</span> <span style="color: #990000">$</span> mkResponse r<span style="color: #990000">)</span> e</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">runAction</span> is where all the unpacking is happening. The
<span class="monospaced">catchError</span> function runs the <span class="monospaced">ActionT e m a</span> monad if that raises an
error, then handles the error using the <span class="monospaced">defH h</span> handler. The <span class="monospaced">defH h</span>
handler handles exception.</p></div>
<div class="paragraph"><p>Now, lets look at how the <span class="monospaced">action</span> is run.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
runAM returns ExceptT
</p>
</li>
<li>
<p>
runExceptT returns the ReaderT
</p>
</li>
<li>
<p>
Since, runReaderT takes the reader and then the environment,
     we apply <span class="monospaced">flip</span> to runReaderT. This way we can apply the <span class="monospaced">env</span>
     and then provide the actual <span class="monospaced">Reader</span> monad as a parameter.
</p>
</li>
<li>
<p>
Similarly, we unwrap the <span class="monospaced">StateT</span> , apply <span class="monospaced">flip</span> so that we
     can apply the function to <span class="monospaced">def</span> before we apply the
     function to wrapped state.
</p>
</li>
<li>
<p>
This computation returns (e, r., where e is a <span class="monospaced">Maybe</span> type and
     <span class="monospaced">r</span> is the state that holds the response that is created so far.
</p>
</li>
<li>
<p>
<span class="monospaced">either</span> return <span class="monospaced">Maybe</span> value of the <span class="monospaced">Response</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>What this means is, the <span class="monospaced">Request</span> parameters are available in
<span class="monospaced">env</span>. Therefore, using the <span class="monospaced">params</span> function we can access those
values. Also, in our sample app, the action returns a modified
<span class="monospaced">Response</span>. That is the <span class="monospaced">state</span> in <span class="monospaced">ScottyResponse</span> is updated in each
<span class="monospaced">action</span>. In summary, any function whose type as ActionT e m a, has
access to <span class="monospaced">Reader</span> monad related functions to <span class="monospaced">ask</span> for request params and also also
has access to <span class="monospaced">State</span> monad related functions like <span class="monospaced">modify</span> to update
the <span class="monospaced">Response</span>.</p></div>
<div class="paragraph"><p>This actual accessing of <span class="monospaced">Request</span> and update of <span class="monospaced">Response</span> will
discussed in the later chapters. It could be useful to refer back
to this section while reading about how parameters are handled and how
the response is updated.</p></div>
<div class="sect2">
<h3 id="_acessing_request_parameters">Acessing Request Parameters</h3>
<div class="paragraph"><p>Let us start with an example that uses the query parameters that is
passed along with the request</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>get <span style="color: #FF0000">"/:username"</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    username <span style="color: #990000">&lt;-</span> param <span style="color: #FF0000">"username"</span>
    <span style="font-style: italic"><span style="color: #9A1900">--  use username in the action</span></span></tt></pre></div></div>
<div class="paragraph"><p>As we have seen earlier, the third parameter to the <span class="monospaced">get</span> function
is the <span class="monospaced">ActionT e m a</span> value. Therefore, <span class="monospaced">param</span> also returns a
<span class="monospaced">ActionT e m a</span> values, where <span class="monospaced">a</span> will either be the value of
<span class="monospaced">username</span> passed in the request if the parameter is found or it might return an error.</p></div>
<div class="paragraph"><p>In this section we will study how the request parameters are parsed in
Scotty. Recall, that in <span class="monospaced">route</span> function, we have a call to
<span class="monospaced">mkEnv</span>. This function captures all the information about the
<span class="monospaced">request</span> into the <span class="monospaced">ActionEnv</span> record.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Internal/Types.hs#L109">ActionEnv</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">ActionEnv</span> <span style="color: #990000">=</span> <span style="color: #009900">Env</span> <span style="color: #990000">{</span> getReq       <span style="color: #990000">::</span> <span style="color: #009900">Request</span>
                     <span style="color: #990000">,</span> getParams    <span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">Param</span><span style="color: #990000">]</span>
                     <span style="color: #990000">,</span> getBody      <span style="color: #990000">::</span> <span style="color: #009900">IO</span> <span style="color: #009900">ByteString</span>
                     <span style="color: #990000">,</span> getBodyChunk <span style="color: #990000">::</span> <span style="color: #009900">IO</span> BS<span style="color: #990000">.</span><span style="color: #009900">ByteString</span>
                     <span style="color: #990000">,</span> getFiles     <span style="color: #990000">::</span> <span style="color: #990000">[</span><span style="color: #009900">File</span><span style="color: #990000">]</span>
                     <span style="color: #990000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">getParams</span> attribute of this record type captures all the request
params.</p></div>
<div class="paragraph"><p>The two functions used to lookup parameters are defined as follows:</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L181">param</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>param <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">Parsable</span> a<span style="color: #990000">,</span> <span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> T<span style="color: #990000">.</span><span style="color: #009900">Text</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m a
param k <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    val <span style="color: #990000">&lt;-</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">$</span> liftM <span style="color: #990000">(</span>lookup k <span style="color: #990000">.</span> getParams<span style="color: #990000">)</span> ask
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> val <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
        <span style="color: #009900">Nothing</span> <span style="color: #990000">-&gt;</span> raise <span style="color: #990000">$</span> stringError <span style="color: #990000">$</span> <span style="color: #FF0000">"Param: "</span> <span style="color: #990000">++</span> T<span style="color: #990000">.</span>unpack k <span style="color: #990000">++</span> <span style="color: #FF0000">" not found!"</span>
        <span style="color: #009900">Just</span> v  <span style="color: #990000">-&gt;</span> either <span style="color: #990000">(</span>const next<span style="color: #990000">)</span> return <span style="color: #990000">$</span> parseParam v</tt></pre></div></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L195">params</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-style: italic"><span style="color: #9A1900">-- | Get all parameters from capture, form and query (in that order).</span></span>
params <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">[</span><span style="color: #009900">Param</span><span style="color: #990000">]</span>
params <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">$</span> liftM getParams ask
</tt></pre></div></div>
<div class="paragraph"><p>Recollect, <span class="monospaced">ActionT</span> wraps the <span class="monospaced">ReaderT</span> monad. Therefore, the
<span class="monospaced">ActionEnv</span> values is passed in as the environment. <span class="monospaced">ask</span> returns
<span class="monospaced">ActionEnv</span> and then <span class="monospaced">getParams</span> returns <span class="monospaced">[Params]</span>. We <span class="monospaced">liftM</span>
getParams since <span class="monospaced">ask</span> is <span class="monospaced">Reader m a</span>. We put the value back into
<span class="monospaced">ActionT</span> before returning. All parameters are parsed using the `
parseParams` method of the <span class="monospaced">Parseable</span> type class.</p></div>
<div class="paragraph"><p>Other functions defined in <span class="monospaced">Action.hs</span> that can be used to access
<span class="monospaced">Request</span> are as follows:</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L143">Functions
to access Request</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- | Get the 'Request' object.</span></span>
request <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #009900">Request</span>
request <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">$</span> liftM getReq ask

<span style="font-style: italic"><span style="color: #9A1900">-- | Get list of uploaded files.</span></span>
files <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">[</span><span style="color: #009900">File</span><span style="color: #990000">]</span>
files <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">$</span> liftM getFiles ask

<span style="font-style: italic"><span style="color: #9A1900">-- | Get a request header. Header name is case-insensitive.</span></span>
header <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> T<span style="color: #990000">.</span><span style="color: #009900">Text</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">(</span><span style="color: #009900">Maybe</span> T<span style="color: #990000">.</span><span style="color: #009900">Text</span><span style="color: #990000">)</span>
header k <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    hs <span style="color: #990000">&lt;-</span> liftM requestHeaders request
    return <span style="color: #990000">$</span> fmap strictByteStringToLazyText <span style="color: #990000">$</span> lookup <span style="color: #990000">(</span>CI<span style="color: #990000">.</span>mk <span style="color: #990000">(</span>lazyTextToStrictByteString k<span style="color: #990000">))</span> hs

<span style="font-style: italic"><span style="color: #9A1900">-- | Get all the request headers. Header names are case-insensitive.</span></span>
headers <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">[(</span>T<span style="color: #990000">.</span><span style="color: #009900">Text</span><span style="color: #990000">,</span> T<span style="color: #990000">.</span><span style="color: #009900">Text</span><span style="color: #990000">)]</span>
headers <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    hs <span style="color: #990000">&lt;-</span> liftM requestHeaders request
    return <span style="color: #990000">[</span> <span style="color: #990000">(</span> strictByteStringToLazyText <span style="color: #990000">(</span>CI<span style="color: #990000">.</span>original k<span style="color: #990000">)</span>
             <span style="color: #990000">,</span> strictByteStringToLazyText v<span style="color: #990000">)</span>
           <span style="color: #990000">|</span> <span style="color: #990000">(</span>k<span style="color: #990000">,</span>v<span style="color: #990000">)</span> <span style="color: #990000">&lt;-</span> hs <span style="color: #990000">]</span>

<span style="font-style: italic"><span style="color: #9A1900">-- | Get the request body.</span></span>
body <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span>  <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m BL<span style="color: #990000">.</span><span style="color: #009900">ByteString</span>
body <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> ask <span style="color: #990000">&gt;&gt;=</span> <span style="color: #990000">(</span>liftIO <span style="color: #990000">.</span> getBody<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">-- | Get an IO action that reads body chunks</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- * This is incompatible with 'body' since 'body' consumes all chunks.</span></span>
bodyReader <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">(</span><span style="color: #009900">IO</span> B<span style="color: #990000">.</span><span style="color: #009900">ByteString</span><span style="color: #990000">)</span>
bodyReader <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">$</span> getBodyChunk <span style="color: #990000">`</span>liftM<span style="color: #990000">`</span> ask

<span style="font-style: italic"><span style="color: #9A1900">-- | Parse the request body as a JSON object and return it. Raises an exception if parse is unsuccessful.</span></span>
jsonData <span style="color: #990000">::</span> <span style="color: #990000">(</span>A<span style="color: #990000">.</span><span style="color: #009900">FromJSON</span> a<span style="color: #990000">,</span> <span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">MonadIO</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #009900">ActionT</span> e m a
jsonData <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    b <span style="color: #990000">&lt;-</span> body
    either <span style="color: #990000">(\</span>e <span style="color: #990000">-&gt;</span> raise <span style="color: #990000">$</span> stringError <span style="color: #990000">$</span> <span style="color: #FF0000">"jsonData - no parse: "</span> <span style="color: #990000">++</span> e <span style="color: #990000">++</span> <span style="color: #FF0000">". Data was:"</span> <span style="color: #990000">++</span> BL<span style="color: #990000">.</span>unpack b<span style="color: #990000">)</span> return <span style="color: #990000">$</span> A<span style="color: #990000">.</span>eitherDecode b</tt></pre></div></div>
<div class="paragraph"><p>All the above listed functions work on the <span class="monospaced">ActionEnv</span> value mentioned
earlier. The <span class="monospaced">mkEnv</span> function is responsible for creating this value
from the raw request data. We do not discuss the details of this
function in this book. But, if you are interested in understanding the
lower level details of how the <span class="monospaced">Request</span> object is parsed into the
<span class="monospaced">ActionEnv</span> value, then this function is where you should start.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L144">mkEnv</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>mkEnv <span style="color: #990000">::</span> forall m<span style="color: #990000">.</span> <span style="color: #009900">MonadIO</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">Request</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">[</span><span style="color: #009900">Param</span><span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span> m <span style="color: #009900">ActionEnv</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_response">Response</h2>
<div class="sectionbody">
<div class="paragraph"><p>Finally, we look at how the responses are created. If you have
followed along than you have would have noticed that the <span class="monospaced">ActionT</span>
values holds the <span class="monospaced">Response</span> in its <span class="monospaced">state</span>. The response is created
during the call to <span class="monospaced">runAction</span> function. Here is the example we started with</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>get <span style="color: #FF0000">"/:username"</span> <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    username <span style="color: #990000">&lt;-</span> param <span style="color: #FF0000">"username"</span>
    html <span style="color: #990000">$</span> mconcat <span style="color: #990000">[</span><span style="color: #FF0000">"&lt;h1&gt; Hello, "</span><span style="color: #990000">,</span> username <span style="color: #990000">,</span> <span style="color: #FF0000">"&lt;/h1&gt;"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>The action is run in the <span class="monospaced">ActionT</span> monad. The call to <span class="monospaced">param</span> leaves
the state unchanged. The call to <span class="monospaced">html</span>, as seen below, along with
the <span class="monospaced">raw</span> function updates the state in the <span class="monospaced">ActionT</span>.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L285">html</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-style: italic"><span style="color: #9A1900">-- | Set the body of the response to the given 'T.Text' value. Also sets \"Content-Type\"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- header to \"text/html; charset=utf-8\" if it has not already been set.</span></span>
html <span style="color: #990000">::</span> <span style="color: #990000">(</span><span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> T<span style="color: #990000">.</span><span style="color: #009900">Text</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span>
html t <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    changeHeader addIfNotPresent <span style="color: #FF0000">"Content-Type"</span> <span style="color: #FF0000">"text/html; charset=utf-8"</span>
    raw <span style="color: #990000">$</span> encodeUtf8 t</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">html</span> function adds a header to the response and applies <span class="monospaced">raw</span>
to the encoded text.</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L305">raw</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- | Set the body of the response to the given 'BL.ByteString' value. Doesn't set the</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- \"Content-Type\" header, so you probably want to do that on your</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- own with 'setHeader'.</span></span>
raw <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> BL<span style="color: #990000">.</span><span style="color: #009900">ByteString</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span>
raw <span style="color: #990000">=</span>
<span style="color: #009900">ActionT</span> <span style="color: #990000">.</span> MS<span style="color: #990000">.</span>modify <span style="color: #990000">.</span> setContent <span style="color: #990000">.</span> <span style="color: #009900">ContentBuilder</span> <span style="color: #990000">.</span> fromLazyByteString</tt></pre></div></div>
<div class="paragraph"><p>Here the <span class="monospaced">raw</span> function create a <span class="monospaced">Content</span> value and set the
<span class="monospaced">srContent</span> attribute of the <span class="monospaced">ScottyResponse</span> value. Notice, that
<span class="monospaced">raw</span> has a return type of <span class="monospaced">ActionT e m ()</span>. This function updates the
<span class="monospaced">state</span> in <span class="monospaced">ActionT</span>. The <span class="monospaced">state</span> in <span class="monospaced">ActionT</span> is the <span class="monospaced">response</span> that
is accumulated before it is served.</p></div>
<div class="paragraph"><p>Other functions that can be used to send different responses  are as
follows:</p></div>
<div class="paragraph"><p><a href="https://github.com/gdevanla/scotty/blob/master/Web/Scotty/Action.hs#L300">Functions
to create Response</a></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">-- | Send a file as the response. Doesn't set the \"Content-Type\" header, so you probably</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- want to do that on your own with 'setHeader'.</span></span>
file <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">FilePath</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span>
file <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">.</span> MS<span style="color: #990000">.</span>modify <span style="color: #990000">.</span> setContent <span style="color: #990000">.</span> <span style="color: #009900">ContentFile</span>

<span style="font-style: italic"><span style="color: #9A1900">-- | Set the body of the response to the JSON encoding of the given value. Also sets \"Content-Type\"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- header to \"application/json; charset=utf-8\" if it has not already been set.</span></span>
json <span style="color: #990000">::</span> <span style="color: #990000">(</span>A<span style="color: #990000">.</span><span style="color: #009900">ToJSON</span> a<span style="color: #990000">,</span> <span style="color: #009900">ScottyError</span> e<span style="color: #990000">,</span> <span style="color: #009900">Monad</span> m<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> a <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span>
json v <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    changeHeader addIfNotPresent <span style="color: #FF0000">"Content-Type"</span> <span style="color: #FF0000">"application/json; charset=utf-8"</span>
    raw <span style="color: #990000">$</span> A<span style="color: #990000">.</span>encode v

<span style="font-style: italic"><span style="color: #9A1900">-- | Set the body of the response to a Source. Doesn't set the</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- \"Content-Type\" header, so you probably want to do that on your</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- own with 'setHeader'.</span></span>
stream <span style="color: #990000">::</span> <span style="color: #009900">Monad</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">StreamingBody</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">ActionT</span> e m <span style="color: #990000">()</span>
stream <span style="color: #990000">=</span> <span style="color: #009900">ActionT</span> <span style="color: #990000">.</span> MS<span style="color: #990000">.</span>modify <span style="color: #990000">.</span> setContent <span style="color: #990000">.</span> <span style="color: #009900">ContentStream</span>
</tt></pre></div></div>
<div class="paragraph"><p>Therefore, we have seen that having the functions discussed above run
in the <span class="monospaced">ActionT</span> monad helps them modify the <span class="monospaced">Response</span> which is
finally returned to the client. These functions, along with the
functions we looked at in the previous chapter, all run in the
<span class="monospaced">ActionT</span> monad and therefore can <span class="monospaced">ask</span> for parameters and <span class="monospaced">modify</span>
the response.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_epilogue">Epilogue</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Scotty library is a light weight library to build web
applications. It also provides a good introduction to practical
implementation of Haskell based programs. The purpose of this book is
to help the user navigate through the source code of the Scotty
library.</p></div>
<div class="paragraph"><p>We started with a toy framework to build up a mental model on the
requirements of the framework and how we could build one. With this we
developed the intuition to understand some of the core functionalities the Scotty library
had to implement to run our sample web application. We looked at the
how the route declarations are handled. Then, we looked at how the
state of the application is initialized. Following that we looked at
the various functions to access the request information. Eventually,
we explored some of the functions that can be used to create the
response that can be served to the client.</p></div>
<div class="paragraph"><p>This book does not walk through all the functions implemented in the
Scotty library. But, it attempts to walk through the core functions
that constitute the sequence of calls that occur right from receiving
a request to processing the request and create the response that is
eventually served.</p></div>
<div class="paragraph"><p>For more thorough investigation and understanding of the library, the
readers are encouraged to download the Scotty implementation and
explore other aspects of the implementation.</p></div>
<div class="paragraph"><p>I hope this short but intense read helped the reader look at a real
world example of Haskell. In addition, I hope this book helped the
reader understand the <span class="monospaced">Scotty</span> implementation itself.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated
 2017-05-22 06:20:37 PDT
</div>
</div>



  </article>
</section>
    <footer>
        <hr>
        <div class="social">
            <ul>
                <li><a href="http://github.com/gdevanla">GitHub</a></li>
                <li><a href="http://twitter.com/grdvnl">Twitter</a></li>
            </ul>
            <ul>
                <li>
                    Powered by Pelican
                </li>
            </ul>
        </div><!-- /.social -->


<!--  -->

</body>
</html>